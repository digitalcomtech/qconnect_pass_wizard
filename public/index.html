<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QConnect PASS Wizard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: #f4f6fb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1.5px 4px rgba(0,0,0,0.04);
      padding: 36px 32px 28px 32px;
      max-width: 480px;
      width: 100%;
      margin: 40px 0 24px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 18px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .section {
      margin-bottom: 30px;
      padding: 18px 18px 10px 18px;
      border: 1px solid #e3e7ef;
      border-radius: 10px;
      background: #f9fafc;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      width: 100%;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #2d3a4a;
    }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 14px;
      box-sizing: border-box;
      font-size: 1rem;
      border: 1px solid #d1d7e6;
      border-radius: 6px;
      background: #fff;
      transition: border 0.2s;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border: 1.5px solid #4f8cff;
      outline: none;
    }
    button {
      padding: 11px 26px;
      font-size: 1.05rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(90deg, #4f8cff 0%, #2355e6 100%);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 8px 8px 0;
      box-shadow: 0 2px 8px rgba(79,140,255,0.08);
      transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover {
      background: linear-gradient(90deg, #2355e6 0%, #4f8cff 100%);
      box-shadow: 0 4px 16px rgba(79,140,255,0.13);
    }
    .hidden {
      display: none;
    }
    #clientStatus,
    #vinStatus,
    #installStatus {
      margin-top: 10px;
      font-weight: 600;
      color: #e74c3c;
      text-align: center;
    }
    #successMsg {
      color: #27ae60;
      font-size: 1.1rem;
      margin-top: 24px;
      text-align: center;
      font-weight: 600;
    }
    #imeiVerificationStatus {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      min-height: 20px;
    }
    #imeiVerificationStatus span {
      display: block;
    }
    @media (max-width: 600px) {
      .container {
        padding: 18px 4vw 18px 4vw;
        max-width: 98vw;
      }
      .section {
        padding: 10px 4vw 8px 4vw;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="environmentIndicator" style="position: absolute; top: 10px; right: 10px; background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">PROD</div>
    <h1>QConnect PASS Wizard</h1>

    <!-- STEP 1: Client Name -->
    <div id="clientSection" class="section">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 1: Enter / Select Client Name</h2>
      <form id="clientForm">
        <label for="clientNameInput">Client Name or VIN Start:</label>
        <input
          type="text"
          id="clientNameInput"
          placeholder=""
          autocomplete="off"
        />
        <button type="submit">Submit ‚ñ∂ Load VINs</button>
      </form>
      <p id="clientStatus"></p>
    </div>

    <!-- STEP 2: VIN Selection -->
    <div id="vinSection" class="section hidden">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 2: Choose a VIN (Booked)</h2>
      <div id="selectedPersonName" style="margin-bottom:10px; font-weight:bold;"></div>
      <label for="vinSelect">VIN #:</label>
      <select id="vinSelect">
        <option value="">-- Select VIN --</option>
      </select>
      <button id="backToClientBtn" type="button">‚óÄ Back</button>
      <button id="nextVinBtn">Next ‚ñ∂ Enter IMEI & SIM</button>
      <p id="vinStatus"></p>
    </div>

    <!-- STEP 3: IMEI & SIM (POST to `/api/install`) -->
    <div id="deviceSection" class="section hidden">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 3: Enter IMEI & SIM</h2>
      <label for="imeiInput">IMEI (Primary Device)</label>
      <div style="display:flex; gap:8px; align-items:flex-end;">
        <input
          type="text"
          id="imeiInput"
          placeholder="Enter IMEI"
          style="flex:1;"
        />
        <button id="verifyImeiBtn" type="button" style="white-space:nowrap;">Verify IMEI</button>
      </div>
      <div id="imeiVerificationStatus" style="margin-bottom:14px;"></div>
      
      <label for="imeiConfirmInput">Retype IMEI</label>
      <input
        type="text"
        id="imeiConfirmInput"
        placeholder="Retype IMEI"
      />

      <label for="simInput">SIM Card # (Optional)</label>
      <input
        type="text"
        id="simInput"
        placeholder="Leave blank if no SIM card"
      />
      <label for="simConfirmInput">Retype SIM Card # (Optional)</label>
      <input
        type="text"
        id="simConfirmInput"
        placeholder="Retype SIM Card # (optional)"
      />

      <label style="display:flex;align-items:center;margin-bottom:8px;">
        <input type="checkbox" id="addSecondaryUnit" style="margin-right:8px;" />
        Add Secondary Unit (IMEI)
      </label>
      <div id="secondaryUnitFields" class="hidden" style="width:100%;">
        <label for="secondaryImeiInput">Secondary IMEI</label>
        <input type="text" id="secondaryImeiInput" placeholder="Enter secondary IMEI" />
      </div>

      <button id="backToVinBtn" type="button">‚óÄ Back</button>
      <button id="startInstallBtn" type="button" disabled>Start Installation ‚ñ∂</button>
      
      <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 6px; padding: 12px; margin-top: 12px; margin-bottom: 12px;">
        <div style="font-weight: 600; color: #2c5aa0; margin-bottom: 8px;">üìç Location Verification</div>
        <div style="font-size: 0.9rem; color: #555; margin-bottom: 12px;">
          The app will verify your location is within 200 meters of the device before proceeding with installation.
        </div>
        
        <!-- Test Mode Location Spoofing -->
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #b3d9ff;">
          <label style="display:flex;align-items:center;margin-bottom:8px;cursor:pointer;">
            <input type="checkbox" id="enableTestMode" style="margin-right:8px;" />
            <span style="font-weight: 600; color: #e67e22;">üß™ Enable Test Mode (Location Spoofing)</span>
          </label>
          <div id="testModeFields" class="hidden" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 10px; margin-top: 8px;">
            <div style="font-size: 0.9rem; color: #856404; margin-bottom: 8px;">
              üí° <strong>Test Mode:</strong> Enter custom coordinates to simulate being at the installation location
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
              <div>
                <label for="testLatInput" style="font-size: 0.8rem; color: #856404;">Test Latitude:</label>
                <input type="number" id="testLatInput" placeholder="e.g., 25.78395" step="0.00001" style="font-size: 0.8rem; padding: 6px 8px;" />
              </div>
              <div>
                <label for="testLonInput" style="font-size: 0.8rem; color: #856404;">Test Longitude:</label>
                <input type="number" id="testLonInput" placeholder="e.g., -100.26345" step="0.00001" style="font-size: 0.8rem; padding: 6px 8px;" />
              </div>
            </div>
            <div style="font-size: 0.8rem; color: #856404;">
              <strong>Current Device Location:</strong> 
              <span id="deviceLocationDisplay">Loading...</span>
              <button id="copyDeviceLocationBtn" type="button" style="background: #17a2b8; color: white; border: none; border-radius: 4px; padding: 2px 6px; margin-left: 8px; font-size: 0.7rem; cursor: pointer;">
                üìã Copy to Test Fields
              </button>
            </div>
            <div style="font-size: 0.8rem; color: #856404; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ffeaa7;">
              üéØ <strong>How to use:</strong> 
              <ol style="margin: 4px 0 4px 16px; padding: 0;">
                <li>Check "Enable Test Mode" above</li>
                <li>Wait for device to report location (or use "Copy to Test Fields")</li>
                <li>Modify coordinates slightly to test proximity logic</li>
                <li>Start installation - app will use your test coordinates</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <p id="installStatus"></p>
    </div>

    <!-- STEP 4: Manual Confirmation -->
    <div id="confirmationSection" class="section hidden">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 4: Finalize Installation</h2>
      <div style="text-align:center; margin-bottom:20px;">
        <div style="font-size:1.1rem; margin-bottom:10px;">‚úÖ Form has been submitted successfully!</div>
        <div style="font-size:0.95rem; color:#666; margin-bottom:20px;">
          Please confirm that the installation is complete and all checks have been performed.
        </div>
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 12px; margin: 0 20px; font-size: 0.9rem; color: #155724;">
          üí° <strong>Note:</strong> Make sure you have completed the installation form that was opened earlier before proceeding with this final confirmation.
        </div>
      </div>
      
      <div style="background:#f9fafc; padding:16px; border-radius:8px; margin-bottom:20px;">
        <h3 style="margin:0 0 10px 0; font-size:1rem; color:#2d3a4a;">Installation Checklist:</h3>
        <div style="font-size:0.9rem; color:#555;">
          ‚òëÔ∏è Device properly mounted and connected<br>
          ‚òëÔ∏è Power connections verified<br>
          ‚òëÔ∏è Ignition wire connected<br>
          ‚òëÔ∏è Input/Output connections tested<br>
          ‚òëÔ∏è Device reporting location successfully
        </div>
      </div>

      <div style="text-align:center;">
        <button id="finalConfirmBtn" type="button" style="background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%); font-size:1.1rem; padding:12px 30px;">
          üîí Confirm & Finalize Installation
        </button>
        <div id="confirmationStatus" style="margin-top:15px; font-weight:600;"></div>
      </div>
    </div>

    <!-- FINAL Success Message -->
    <div id="successMsg" style="display:none; text-align:center; margin-top:32px;">
      <div style="font-size:4rem; color:#27ae60; margin-bottom:16px;">&#10004;</div>
      <div style="font-size:1.3rem; font-weight:700; color:#27ae60; margin-bottom:10px;">Installation Complete!</div>
      <div style="font-size:1.1rem; color:#222;">Thank you for using the QConnect PASS Wizard.<br>You may now close this window.</div>
    </div>
  </div>

  <script>
    sessionStorage.clear();
    // DOM references
    const clientSection       = document.getElementById("clientSection");
    const clientForm          = document.getElementById("clientForm");
    const clientNameInput     = document.getElementById("clientNameInput");
    const clientStatus        = document.getElementById("clientStatus");

    const vinSection          = document.getElementById("vinSection");
    const vinSelect           = document.getElementById("vinSelect");
    const nextVinBtn          = document.getElementById("nextVinBtn");
    const backToClientBtn     = document.getElementById("backToClientBtn");
    const vinStatus           = document.getElementById("vinStatus");

    const deviceSection       = document.getElementById("deviceSection");
    const imeiInput           = document.getElementById("imeiInput");
    const simInput            = document.getElementById("simInput");
    const startInstallBtn     = document.getElementById("startInstallBtn");
    const backToVinBtn        = document.getElementById("backToVinBtn");
    const installStatus       = document.getElementById("installStatus");
    const verifyImeiBtn       = document.getElementById("verifyImeiBtn");
    const imeiVerificationStatus = document.getElementById("imeiVerificationStatus");

    const confirmationSection = document.getElementById("confirmationSection");
    const finalConfirmBtn     = document.getElementById("finalConfirmBtn");
    const confirmationStatus  = document.getElementById("confirmationStatus");
    const successMsg          = document.getElementById("successMsg");

    // State
    let selectedClientName    = "";
    let selectedVIN           = "";
    let selectedInstallationId = "";
    let imeiVerified          = false;
    let appConfig             = null;

    document.addEventListener("DOMContentLoaded", async () => {
      // Check geolocation support
      if (!navigator.geolocation) {
        console.warn("Geolocation not supported by this browser");
        // Add a warning to the UI
        const locationWarning = document.createElement("div");
        locationWarning.style.cssText = "background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; padding: 8px; margin: 8px 0; color: #721c24; font-size: 0.9rem;";
        locationWarning.innerHTML = "‚ö†Ô∏è Geolocation not supported by your browser. You'll need to use manual location override.";
        document.querySelector(".container").insertBefore(locationWarning, document.getElementById("clientSection"));
      }
      
      // Load app configuration first
      await loadAppConfig();
      
      clientForm.addEventListener("submit", onNextClient);
      nextVinBtn.addEventListener("click", onNextVin);
      startInstallBtn.addEventListener("click", onStartInstallation);
      backToClientBtn.addEventListener("click", onBackToClient);
      backToVinBtn.addEventListener("click", onBackToVin);
      verifyImeiBtn.addEventListener("click", onVerifyImei);
      
      // Reset verification when IMEI changes
      imeiInput.addEventListener("input", () => {
        if (imeiVerified) {
          imeiVerified = false;
          startInstallBtn.disabled = true;
          imeiVerificationStatus.innerHTML = '<span style="color:#f39c12;">‚ö†Ô∏è IMEI changed - please verify again</span>';
        }
      });
      
      document.getElementById("addSecondaryUnit").addEventListener("change", function(e) {
        document.getElementById("secondaryUnitFields").classList.toggle("hidden", !e.target.checked);
      });
      
      // Test mode toggle
      document.getElementById("enableTestMode").addEventListener("change", function(e) {
        document.getElementById("testModeFields").classList.toggle("hidden", !e.target.checked);
        if (e.target.checked) {
          updateDeviceLocationDisplay();
        }
      });
      
      // Copy device location to test fields
      document.addEventListener("click", function(e) {
        if (e.target.id === "copyDeviceLocationBtn") {
          const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
          const deviceLat = inst.vehiculo?.latest?.loc?.lat;
          const deviceLon = inst.vehiculo?.latest?.loc?.lon;
          
          if (deviceLat && deviceLon) {
            document.getElementById("testLatInput").value = deviceLat.toFixed(5);
            document.getElementById("testLonInput").value = deviceLon.toFixed(5);
            e.target.textContent = "‚úÖ Copied!";
            setTimeout(() => {
              e.target.textContent = "üìã Copy to Test Fields";
            }, 2000);
          } else {
            alert("Device location not available yet. Please wait for the device to report its location.");
          }
        }
      });
      
      // Final confirmation button
      finalConfirmBtn.addEventListener("click", onFinalConfirmation);
      
      restoreState();
    });

    // Load app configuration
    async function loadAppConfig() {
      try {
        const resp = await fetch("/api/config");
        appConfig = await resp.json();
        console.log(`üîß Frontend loaded ${appConfig.environment.toUpperCase()} environment config`);
        
        // Update page title and indicator to show environment
        const envIndicator = document.getElementById("environmentIndicator");
        if (appConfig.environment === "qa") {
          document.title = "QConnect PASS Wizard (QA)";
          document.querySelector("h1").textContent = "QConnect PASS Wizard (QA)";
          document.querySelector("h1").style.color = "#f39c12";
          envIndicator.textContent = "QA";
          envIndicator.style.background = "#f39c12";
        } else {
          document.title = "QConnect PASS Wizard";
          document.querySelector("h1").textContent = "QConnect PASS Wizard";
          document.querySelector("h1").style.color = "#2d3a4a";
          envIndicator.textContent = "PROD";
          envIndicator.style.background = "#27ae60";
        }
      } catch (err) {
        console.error("Failed to load app config:", err);
        // Fallback to production config
        appConfig = {
          environment: "production",
          testMode: false,
          pegasusBaseUrl: "https://qservices.pegasusgateway.com",
          pegasusToken: "2f2df11d24bba3d071c22ca1c54f42dd64dda64e6bddfe9e6f3cc824"
        };
      }
    }

    // STEP 1 ‚Üí STEP 2
    async function onNextClient(e) {
      e.preventDefault();
      clientStatus.innerText = "";

      selectedClientName = clientNameInput.value.trim();
      if (!selectedClientName) {
        clientStatus.innerText = "üö® Please enter a client name or VIN start.";
        return;
      }
      clientStatus.innerText = "‚Üª Fetching all installations‚Ä¶";

      try {
        const resp = await fetch(
          `${appConfig.pegasusBaseUrl}/installations/api/v1/installation`,
          {
            headers: {
             "Authorization": `Bearer ${appConfig.pegasusToken}`,
              "Content-Type": "application/json"
            }
          }
        );
        if (!resp.ok) throw new Error(`Pegasus returned HTTP ${resp.status}`);
        const installationsArray = await resp.json();

        // Forgiving, dynamic search: match by name or VIN start
        const normalize = str => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : "";
        const inputNorm = normalize(selectedClientName);
        const filtered = installationsArray.filter(inst => {
          const nombre = inst.persona?.nombreAsegurado || "";
          const apellido = inst.persona?.apellidoPaterno || "";
          const fullName = [nombre, apellido].filter(Boolean).join(" ");
          const vin = inst.vehiculo?.serie || "";
          return (
            normalize(fullName).includes(inputNorm) ||
            vin.toUpperCase().startsWith(inputNorm)
          );
        });

        if (filtered.length === 0) {
          clientStatus.innerText = `‚ùå No installations found for "${selectedClientName}".`;
          vinSelect.innerHTML = `<option value="">-- No VINs found --</option>`;
          return;
        }

        vinSelect.innerHTML = `<option value="">-- Select VIN --</option>`;
        // Store the full filtered array for later use
        sessionStorage.setItem("filteredInst", JSON.stringify(filtered));

        filtered.forEach(inst => {
          const vin = inst.vehiculo?.serie;
          if (!vin) return;
          const p = inst.persona || {};
          const fullName = [p.nombreAsegurado, p.nombreMedioAsegurado, p.apellidoPaterno, p.apellidoMaterno].filter(Boolean).join(" ");
          const opt = document.createElement("option");
          opt.value = vin;
          opt.textContent = `${vin} ‚Äî ${fullName}`;
          opt.dataset.installationId = inst._id;
          vinSelect.appendChild(opt);
        });

        // Persist
        sessionStorage.setItem("step", "2");
        sessionStorage.setItem("clientName", selectedClientName);

        clientSection.classList.add("hidden");
        vinSection.classList.remove("hidden");

        debugPrint(filtered, "Filtered Installations");
      } catch (err) {
        console.error(err);
        clientStatus.innerText = "‚ùå " + err.message;
      }
    }

    // STEP 2 ‚Üí STEP 3
    function onNextVin() {
      vinStatus.innerText = "";
      const vin = vinSelect.value;
      if (!vin) {
        vinStatus.innerText = "üö® Please select a VIN.";
        return;
      }
      selectedVIN = vin;
      selectedInstallationId = vinSelect.selectedOptions[0].dataset.installationId;

      sessionStorage.setItem("step", "3");
      sessionStorage.setItem("selectedVIN", selectedVIN);
      sessionStorage.setItem("installationId", selectedInstallationId);

      vinSection.classList.add("hidden");
      deviceSection.classList.remove("hidden");

      const filtered = JSON.parse(sessionStorage.getItem("filteredInst") || "[]");
      const inst = filtered.find(inst => inst.vehiculo?.serie === vin);
      let personName = "";
      if (inst && inst.persona) {
        const p = inst.persona;
        personName = [p.nombreAsegurado, p.nombreMedioAsegurado, p.apellidoPaterno, p.apellidoMaterno]
          .filter(Boolean).join(" ");
        sessionStorage.setItem("selectedClientFullName", personName);
      }

      if (inst) {
        // Store the full installation object for later use (for device location)
        sessionStorage.setItem("selectedInstallation", JSON.stringify(inst));
      }
    }

    // IMEI Verification
    async function onVerifyImei() {
      const imei = imeiInput.value.trim();
      if (!imei) {
        imeiVerificationStatus.innerHTML = '<span style="color:#e74c3c;">üö® Please enter an IMEI to verify.</span>';
        return;
      }

      imeiVerificationStatus.innerHTML = '<span style="color:#f39c12;">‚è≥ Verifying IMEI...</span>';
      verifyImeiBtn.disabled = true;

      try {
        const resp = await fetch("/api/verify-imei", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imei })
        });

        const data = await resp.json();

        if (resp.ok && data.success) {
          imeiVerified = true;
          startInstallBtn.disabled = false;
          imeiVerificationStatus.innerHTML = `<span style="color:#27ae60;">‚úÖ IMEI verified successfully! Device state: ${data.deviceState}</span>`;
        } else {
          imeiVerified = false;
          startInstallBtn.disabled = true;
          imeiVerificationStatus.innerHTML = `<span style="color:#e74c3c;">‚ùå ${data.message}</span>`;
        }
      } catch (err) {
        console.error("Error verifying IMEI:", err);
        imeiVerified = false;
        startInstallBtn.disabled = true;
        imeiVerificationStatus.innerHTML = '<span style="color:#e74c3c;">‚ùå Error connecting to verification service</span>';
      } finally {
        verifyImeiBtn.disabled = false;
      }
    }

    // STEP 3 ‚Üí STEP 4
    async function onStartInstallation() {
      installStatus.innerText = "";
      
      // Check if IMEI has been verified
      if (!imeiVerified) {
        installStatus.innerText = "üö® Please verify the IMEI before proceeding with installation.";
        return;
      }
      
      const imei = imeiInput.value.trim();
      const imeiConfirm = document.getElementById("imeiConfirmInput").value.trim();
      const sim = simInput.value.trim();
      const simConfirm = document.getElementById("simConfirmInput").value.trim();
      const secondaryImei = document.getElementById("secondaryImeiInput").value.trim();
      const addSecondary = document.getElementById("addSecondaryUnit").checked;
      if (!imei) {
        installStatus.innerText = "üö® Please enter IMEI.";
        return;
      }
      if (imei !== imeiConfirm) {
        installStatus.innerText = "üö® IMEI values do not match.";
        return;
      }
      // Only validate SIM if provided
      if (sim && sim !== simConfirm) {
        installStatus.innerText = "üö® SIM values do not match.";
        return;
      }
      if (addSecondary && !secondaryImei) {
        installStatus.innerText = "üö® Please enter the secondary IMEI.";
        return;
      }
      installStatus.innerText = "‚Üª Sending IMEI & SIM to server‚Ä¶";

      try {
        const payload = {
          client_name: sessionStorage.getItem("selectedClientFullName") || selectedClientName,
          imei,
          vin: selectedVIN,
          installationId: selectedInstallationId
        };
        // Only include SIM if provided
        if (sim) {
          payload.sim_number = sim;
        }
        if (addSecondary && secondaryImei) {
          payload.secondary_imei = secondaryImei;
        }
        const resp = await fetch("/api/install", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== "success") throw new Error(data.message || `Status: ${data.status}`);

        sessionStorage.setItem("step", "waitingForDevice");
        const testModeNote = document.getElementById("enableTestMode").checked ? 
          '<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 8px; margin-top: 8px; font-size: 0.8rem; color: #856404;">üß™ <strong>Test Mode Active:</strong> Will use custom coordinates instead of GPS</div>' : '';
        
        installStatus.innerHTML = `
          <div style="margin-bottom: 15px;">
            <div style="font-size: 1.1rem; color: #2c5aa0; margin-bottom: 8px;">
              ‚è≥ Starting device location monitoring...
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
              <strong>Initial interval:</strong> 10 seconds | <strong>Maximum duration:</strong> 30 minutes
            </div>
            <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 6px; padding: 8px; font-size: 0.8rem; color: #2c5aa0;">
              üí° <strong>Smart polling:</strong> We'll check less frequently over time to avoid overwhelming the system.
            </div>
            ${testModeNote}
          </div>
          <button id="stopPollingBtn" type="button" style="background: #e74c3c; margin-top: 8px; font-size: 0.9rem;">üõë Stop Waiting</button>
        `;

        // Initialize polling control
        window.stopPolling = false;

        // Add stop polling functionality
        document.getElementById("stopPollingBtn").addEventListener("click", () => {
          window.stopPolling = true;
          installStatus.innerHTML = "üõë Stopped waiting for device. You can restart the installation process.";
        });

        // Start polling for device status
        pollForDeviceReporting();
      } catch (err) {
        console.error(err);
        installStatus.innerText = "‚ùå " + err.message;
      }
    }

    function pollForDeviceReporting() {
      // Smart polling with progressive backoff and extended timeout
      const MAX_DURATION = 30 * 60 * 1000; // 30 minutes total
      const INITIAL_INTERVAL = 10000; // Start with 10 seconds
      const MAX_INTERVAL = 120000; // Max 2 minutes between checks
      const BACKOFF_MULTIPLIER = 1.5; // Increase interval by 50% each time
      
      let attempts = 0;
      let currentInterval = INITIAL_INTERVAL;
      let startTime = Date.now();
      let lastLocationCheck = null;
      let consecutiveLocationFailures = 0;
      const MAX_CONSECUTIVE_FAILURES = 3; // Allow some wrong locations before giving up

      // Update the status display with better information
      function updateStatusDisplay() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const nextCheckIn = Math.ceil(currentInterval / 1000);
        
        installStatus.innerHTML = `
          <div style="margin-bottom: 15px;">
            <div style="font-size: 1.1rem; color: #2c5aa0; margin-bottom: 8px;">
              ‚è≥ Waiting for device to report location...
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
              <strong>Elapsed time:</strong> ${timeStr} | <strong>Next check in:</strong> ${nextCheckIn}s
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
              <strong>Attempts:</strong> ${attempts} | <strong>Current interval:</strong> ${Math.ceil(currentInterval/1000)}s
            </div>
            <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 6px; padding: 8px; font-size: 0.8rem; color: #2c5aa0;">
              üí° <strong>Tip:</strong> Device may take up to 30 minutes to report. We'll check less frequently over time to avoid overwhelming the system.
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 8px; font-size: 0.8rem; color: #856404; margin-top: 8px;">
              üîç <strong>Enhanced Requirements:</strong> Device must be online, have recent connection data (‚â§5min), recent network activity (‚â§5min), AND fresh location data (‚â§60s old)
            </div>
          </div>
          <button id="stopPollingBtn" type="button" style="background: #e74c3c; margin-top: 8px; font-size: 0.9rem;">üõë Stop Waiting</button>
          <button id="forceLocationCheckBtn" type="button" style="background: #3498db; margin-left: 8px; font-size: 0.9rem;">üîç Check Now</button>
        `;

        // Add event listeners for the new buttons
        document.getElementById("stopPollingBtn").addEventListener("click", () => {
          window.stopPolling = true;
          installStatus.innerHTML = "üõë Stopped waiting for device. You can restart the installation process.";
        });

        document.getElementById("forceLocationCheckBtn").addEventListener("click", () => {
          // Force an immediate check
          currentInterval = 1000; // Check in 1 second
          checkStatus();
        });
      }

      async function checkStatus() {
        // Check if polling was stopped
        if (window.stopPolling) {
          console.log("Polling stopped by user");
          return;
        }

        // Check if we've exceeded the maximum duration
        if (Date.now() - startTime > MAX_DURATION) {
          installStatus.innerHTML = `
            <div style="color: #e74c3c; margin-bottom: 15px;">
              <div style="font-size: 1.1rem; margin-bottom: 8px;">‚è∞ Time limit reached (30 minutes)</div>
              <div style="font-size: 0.9rem; margin-bottom: 15px;">
                The device has not reported location within the expected timeframe. This could indicate:
              </div>
              <ul style="font-size: 0.9rem; margin-bottom: 15px; padding-left: 20px;">
                <li>Device is not properly connected or powered</li>
                <li>Network connectivity issues</li>
                <li>Device configuration problems</li>
              </ul>
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
              <strong>Options:</strong>
              <div style="margin-top: 8px;">
                <button id="retryPollingBtn" type="button" style="background: #3498db; margin-right: 8px; font-size: 0.9rem;">üîÑ Restart Polling</button>
              </div>
            </div>
          `;

          // Add event listeners for the options
          document.getElementById("retryPollingBtn").addEventListener("click", () => {
            startTime = Date.now();
            attempts = 0;
            currentInterval = INITIAL_INTERVAL;
            consecutiveLocationFailures = 0;
            checkStatus();
          });

          return;
        }

        attempts++;
        console.log(`Checking device status (attempt ${attempts}, interval: ${Math.ceil(currentInterval/1000)}s)...`);
        
        // Update status display
        updateStatusDisplay();

        try {
                  // Call backend endpoint to check device status
        const resp = await fetch(`/api/device-status?imei=${encodeURIComponent(imeiInput.value.trim())}`);
        const data = await resp.json();
        
        // Log detailed device status for debugging
        console.log("Device status check:", {
          isReporting: data.isReporting,
          hasValidLocation: data.latest?.loc?.valid,
          isOnline: data.connection?.online,
          connectionState: data.connection?.state,
          locationAge: data.latest?.loc?.age,
          locationData: data.latest?.loc
        });
        
        // Also log the full response for debugging
        console.log("Full device status response:", data);

          // Enhanced validation using backend analysis
          const isDeviceOnline = data.isOnline === true;
          const hasValidLocation = data.latest?.loc?.valid === true;
          const locationAge = data.latest?.loc?.age || 0; // Age in seconds
          const hasRecentConnection = data.hasRecentConnection === true;
          const hasRecentActivity = data.hasRecentActivity === true;
          
          // Update device location display for test mode
          if (document.getElementById("enableTestMode").checked) {
            updateDeviceLocationDisplay();
          }
          
          // Comprehensive validation - ALL conditions must be true
          if (data.isReporting && hasValidLocation && isDeviceOnline && hasRecentConnection && hasRecentActivity && locationAge <= 60) {
            console.log("Device is online and reporting fresh location, checking proximity...");
            
            // Get device location data
            const deviceLat = data.latest.loc.lat;
            const deviceLon = data.latest.loc.lon;

            if (deviceLat == null || deviceLon == null) {
              console.log("Device location data incomplete, continuing to poll...");
              scheduleNextCheck();
              return;
            }

            // Check if this is a reasonable location (not obviously wrong)
            if (Math.abs(deviceLat) > 90 || Math.abs(deviceLon) > 180) {
              console.log("Device reported invalid coordinates, continuing to poll...");
              scheduleNextCheck();
              return;
            }

            // Check location age - if it's very old, it might be stale data
            if (locationAge > 300) { // 5 minutes old
              console.log(`Device location is ${locationAge}s old, might be stale. Continuing to poll...`);
              scheduleNextCheck();
              return;
            }

            // Now check user proximity to device
            await checkUserProximity(deviceLat, deviceLon);
            
          } else {
            // Enhanced logging showing exactly why each check failed
            console.log("üîç Device validation failed - analyzing reasons:");
            
            if (!data.isReporting) {
              console.log("‚ùå Device not reporting data yet");
            } else {
              console.log("‚úÖ Device is reporting data");
            }
            
            if (!hasValidLocation) {
              console.log("‚ùå Device data available but no valid location");
            } else {
              console.log("‚úÖ Device has valid location");
            }
            
            if (!isDeviceOnline) {
              console.log("‚ùå Device has location but is offline");
            } else {
              console.log("‚úÖ Device connection is online");
            }
            
            if (!hasRecentConnection) {
              console.log("‚ùå Device connection data is stale (>5 minutes old)");
            } else {
              console.log("‚úÖ Device has recent connection data");
            }
            
            if (!hasRecentActivity) {
              console.log("‚ùå Device has no recent network activity (>5 minutes)");
            } else {
              console.log("‚úÖ Device has recent network activity");
            }
            
            if (locationAge > 60) {
              console.log(`‚ùå Device location is too old (${locationAge}s > 60s)`);
            } else {
              console.log(`‚úÖ Device location is fresh (${locationAge}s ‚â§ 60s)`);
            }
            
            console.log("üìä Summary:", {
              isReporting: data.isReporting,
              hasValidLocation,
              isDeviceOnline,
              hasRecentConnection,
              hasRecentActivity,
              locationAge,
              dataFreshness: data.dataFreshness
            });
            
            scheduleNextCheck();
          }

        } catch (error) {
          console.error("Error checking device status:", error);
          // Don't stop polling on errors, just continue
          scheduleNextCheck();
        }
      }

              // Function to check user proximity to device
        async function checkUserProximity(deviceLat, deviceLon) {
          try {
            // Check if test mode is enabled
            const testModeEnabled = document.getElementById("enableTestMode").checked;
            
            if (testModeEnabled) {
              // Use test coordinates
              const testLat = parseFloat(document.getElementById("testLatInput").value);
              const testLon = parseFloat(document.getElementById("testLonInput").value);
              
              if (isNaN(testLat) || isNaN(testLon)) {
                console.log("Test coordinates not entered, continuing to poll...");
                scheduleNextCheck();
                return;
              }
              
              console.log(`üß™ Test Mode: Using coordinates ${testLat}, ${testLon}`);
              console.log(`üß™ Device coordinates: ${deviceLat}, ${deviceLon}`);
              const distance = haversineDistance(testLat, testLon, deviceLat, deviceLon);
              console.log(`üß™ Calculated distance: ${distance.toFixed(2)}m`);
              
              if (distance < 200) {
                handleProximitySuccess("Test Mode");
              } else {
                handleProximityFailure(distance, "Test Mode");
              }
            } else {
              // Use GPS location
              navigator.geolocation.getCurrentPosition(
                function(position) {
                  const userLat = position.coords.latitude;
                  const userLon = position.coords.longitude;
                  const distance = haversineDistance(userLat, userLon, deviceLat, deviceLon);
                  
                  if (distance < 200) {
                    handleProximitySuccess("GPS");
                  } else {
                    handleProximityFailure(distance, "GPS");
                  }
                },
                function(error) {
                  console.log("GPS error, showing manual location options...");
                  showManualLocationOverride(deviceLat, deviceLon);
                },
                { 
                  enableHighAccuracy: true, 
                  timeout: 15000, 
                  maximumAge: 60000 
                }
              );
            }

        } catch (error) {
          console.error("Error in proximity check:", error);
          scheduleNextCheck();
        }
      }

      // Handle successful proximity check
      function handleProximitySuccess(method) {
        console.log(`Proximity check successful via ${method}`);
        const testModeIndicator = method === "Test Mode" ? 
          '<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 8px; margin-bottom: 12px; font-size: 0.9rem; color: #856404;">üß™ <strong>Test Mode Active:</strong> Using custom coordinates for proximity check</div>' : '';
        
        installStatus.innerHTML = `
          <div style="color: #27ae60; margin-bottom: 15px;">
            <div style="font-size: 1.1rem; margin-bottom: 8px;">‚úÖ Location check passed!</div>
            <div style="font-size: 0.9rem; margin-bottom: 15px;">
              You are within 200 meters of the device. Opening installation form...
            </div>
            ${testModeIndicator}
          </div>
        `;
        
        setTimeout(() => {
          openPrefilledForm();
          // Show form completion interface
          installStatus.innerHTML = `
            <div style="color: #27ae60; margin-bottom: 10px;">‚úÖ Location check passed!</div>
            <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
              <div style="font-weight: 600; color: #2c5aa0; margin-bottom: 8px;">üìã Form Opened</div>
              <div style="font-size: 0.9rem; color: #555; margin-bottom: 12px;">
                The installation form has been opened in a new tab. Please complete the form, then return here and click the button below to continue.
              </div>
              <button id="formCompletedBtn" type="button" style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
                ‚úÖ I've Completed the Form - Continue to Confirmation
              </button>
            </div>
          `;
          
          // Add event listener for the form completion button
          document.getElementById("formCompletedBtn").addEventListener("click", function() {
            showConfirmationStep();
          });
        }, 1000);
      }

      // Handle proximity check failure
      function handleProximityFailure(distance, method) {
        consecutiveLocationFailures++;
        console.log(`Proximity check failed via ${method}. Distance: ${distance.toFixed(0)}m. Failures: ${consecutiveLocationFailures}`);
        
        if (consecutiveLocationFailures >= MAX_CONSECUTIVE_FAILURES) {
          // Too many consecutive failures, show manual options
          installStatus.innerHTML = `
            <div style="color: #e74c3c; margin-bottom: 15px;">
              <div style="font-size: 1.1rem; margin-bottom: 8px;">üìç Location mismatch detected</div>
              <div style="font-size: 0.9rem; margin-bottom: 15px;">
                Device location: ${distance.toFixed(0)}m away from your position.<br>
                This could be due to:
              </div>
              <ul style="font-size: 0.9rem; margin-bottom: 15px; padding-left: 20px;">
                <li>Device reporting its last known location (not current)</li>
                <li>GPS accuracy issues on either device</li>
                <li>Device not yet moved to installation location</li>
              </ul>
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
              <strong>Options:</strong>
              <div style="margin-top: 8px;">
                <button id="continuePollingBtn" type="button" style="background: #3498db; margin-right: 8px; font-size: 0.9rem;">üîÑ Continue Waiting</button>
              </div>
            </div>
          `;

          // Add event listeners
          document.getElementById("continuePollingBtn").addEventListener("click", () => {
            consecutiveLocationFailures = 0; // Reset counter
            scheduleNextCheck();
          });

        } else {
          // Just continue polling, but show the issue
          installStatus.innerHTML = `
            <div style="color: #f39c12; margin-bottom: 15px;">
              <div style="font-size: 1.1rem; margin-bottom: 8px;">‚ö†Ô∏è Location mismatch (${consecutiveLocationFailures}/${MAX_CONSECUTIVE_FAILURES})</div>
              <div style="font-size: 0.9rem; margin-bottom: 15px;">
                Device is ${distance.toFixed(0)}m away. This might be stale location data.<br>
                Continuing to monitor for updated location...
              </div>
            </div>
            <button id="stopPollingBtn" type="button" style="background: #e74c3c; margin-top: 8px; font-size: 0.9rem;">üõë Stop Waiting</button>
            <button id="forceLocationCheckBtn" type="button" style="background: #3498db; margin-left: 8px; font-size: 0.9rem;">üîç Check Now</button>
          `;

          // Add event listeners
          document.getElementById("stopPollingBtn").addEventListener("click", () => {
            window.stopPolling = true;
            installStatus.innerHTML = "üõë Stopped waiting for device. You can restart the installation process.";
          });

          document.getElementById("forceLocationCheckBtn").addEventListener("click", () => {
            currentInterval = 1000; // Check in 1 second
            checkStatus();
          });

          scheduleNextCheck();
        }
      }


      // Schedule the next check with progressive backoff
      function scheduleNextCheck() {
        if (window.stopPolling) return;
        
        // Increase interval progressively, but cap it
        currentInterval = Math.min(currentInterval * BACKOFF_MULTIPLIER, MAX_INTERVAL);
        
        console.log(`Scheduling next check in ${Math.ceil(currentInterval/1000)}s`);
        setTimeout(checkStatus, currentInterval);
      }

      // Start the first check
      checkStatus();
    }

    function openPrefilledForm() {
      const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
      if (!inst || !inst.vehiculo) {
        alert("No installation data found!");
        return;
      }
      // Map your JSON fields to the form's query params
      const params = new URLSearchParams({
        installationId: inst._id,
        driverName: inst.persona?.nombreAsegurado || "",
        "driverName[last]": inst.persona?.apellidoPaterno || "",
        email: inst.persona?.contactos?.[0]?.email || "",
        serviceType: inst.persona?.tipo || "",
        enterpriseName: inst.persona?.nombreAsegurado + " " + inst.persona?.apellidoPaterno,
        typeA127: "Instalaci√≥n",
        plate: inst.vehiculo?.placas || "",
        make: inst.vehiculo?.marca || "",
        model: inst.vehiculo?.submarca || "",
        ano: inst.vehiculo?.modelo || "",
        vin: inst.vehiculo?.serie || "",
        color: inst.vehiculo?.color || "",
        numeroEconomico: inst.vehiculo?.numeroEconomico || "",
        noDe: inst.vehiculo?.numeroMotor || ""
      });
      const url = `https://forms.fleetmetriks.com/252054474420955?${params.toString()}`;
      window.open(url, "_blank"); // or use location.href = url; to redirect in the same tab
    }

    // BACK handlers
    function onBackToClient() {
      vinSection.classList.add("hidden");
      clientSection.classList.remove("hidden");
    }
    function onBackToVin() {
      deviceSection.classList.add("hidden");
      vinSection.classList.remove("hidden");
    }



    // SHOW CONFIRMATION STEP
    function showConfirmationStep() {
      deviceSection.classList.add("hidden");
      confirmationSection.classList.remove("hidden");
      sessionStorage.setItem("step", "confirmation");
    }

    // FINAL CONFIRMATION HANDLER
    async function onFinalConfirmation() {
      confirmationStatus.innerText = "üîÑ Sending final confirmation to system...";
      finalConfirmBtn.disabled = true;
      
      try {
        const resp = await fetch("/api/confirm-installation", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            installationId: selectedInstallationId 
          })
        });

        const data = await resp.json();

        if (resp.ok && data.success) {
          confirmationStatus.innerText = "‚úÖ Installation confirmed successfully!";
          setTimeout(() => {
            confirmationSection.classList.add("hidden");
            successMsg.style.display = "block";
            sessionStorage.setItem("step", "done");
          }, 1500);
        } else {
          confirmationStatus.innerText = `‚ùå Confirmation failed: ${data.message}`;
          finalConfirmBtn.disabled = false;
          console.error("Confirmation failed:", data);
        }
      } catch (err) {
        console.error("Error confirming installation:", err);
        confirmationStatus.innerText = "‚ùå Error confirming installation. Please try again.";
        finalConfirmBtn.disabled = false;
      }
    }

    // Restore UI on reload
    function restoreState() {
  const step = sessionStorage.getItem("step") || "1";
  // hide everything first
  clientSection.classList.add("hidden");
  vinSection.classList.add("hidden");
  deviceSection.classList.add("hidden");
  confirmationSection.classList.add("hidden");
  successMsg.style.display = "none";

                // Reset IMEI verification state
        imeiVerified = false;
        startInstallBtn.disabled = true;
        imeiVerificationStatus.innerHTML = "";
      
      // Add location permission request button if geolocation is supported
      if (navigator.geolocation) {
        const locationPermissionBtn = document.createElement("button");
        locationPermissionBtn.type = "button";
        locationPermissionBtn.textContent = "üìç Request Location Permission";
        locationPermissionBtn.style.cssText = "background: #17a2b8; font-size: 0.9rem; padding: 8px 16px; margin-top: 8px;";
        locationPermissionBtn.addEventListener("click", requestLocationPermission);
        
        const locationOptionsDiv = document.querySelector(".container").querySelector('[style*="background: #e8f4fd"]');
        if (locationOptionsDiv) {
          locationOptionsDiv.appendChild(locationPermissionBtn);
        }
      }

  if (step === "2") {
    // restore Step 2 UI
    clientNameInput.value = sessionStorage.getItem("clientName") || "";
    const filtered = JSON.parse(sessionStorage.getItem("filteredInst") || "[]");
    vinSelect.innerHTML = `<option value="">-- Select VIN --</option>`;
    filtered.forEach(inst => {
      const vin = inst.vehiculo?.serie;
      if (!vin) return;
      const opt = document.createElement("option");
      opt.value = vin;
      opt.textContent = vin;
      opt.dataset.installationId = inst._id;
      if (vin === sessionStorage.getItem("selectedVIN")) opt.selected = true;
      vinSelect.appendChild(opt);
    });
    vinSection.classList.remove("hidden");

  } else if (step === "3") {
    // restore Step 3 UI
    onNextVin();

  } else if (step === "confirmation") {
    // restore confirmation step
    confirmationSection.classList.remove("hidden");

  } else if (step === "done") {
    // show success message
    successMsg.style.display = "block";

  } else {
    // default to Step 1
    clientSection.classList.remove("hidden");
  }
}

    function debugPrint(obj, label = "") {
      const out = document.getElementById("debugOutput");
      out.textContent = (label ? label + ":\n" : "") + JSON.stringify(obj, null, 2);
    }

    // Update device location display for test mode
    function updateDeviceLocationDisplay() {
      const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
      const deviceLat = inst.vehiculo?.latest?.loc?.lat;
      const deviceLon = inst.vehiculo?.latest?.loc?.lon;
      
      const displayElement = document.getElementById("deviceLocationDisplay");
      if (deviceLat && deviceLon) {
        displayElement.innerHTML = `${deviceLat.toFixed(5)}, ${deviceLon.toFixed(5)}`;
        
        // Auto-populate test coordinates with device location for easy testing
        document.getElementById("testLatInput").value = deviceLat.toFixed(5);
        document.getElementById("testLonInput").value = deviceLon.toFixed(5);
      } else {
        displayElement.innerHTML = "Device location not available yet";
      }
    }
    
    // Request location permission proactively
    function requestLocationPermission() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          alert("‚úÖ Location permission granted! Your coordinates: " + 
                position.coords.latitude.toFixed(6) + ", " + 
                position.coords.longitude.toFixed(6));
        },
        function(error) {
          let errorMsg = "";
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = "Location permission denied. Please:\n1. Click the location icon in your browser's address bar\n2. Select 'Allow' for location access\n3. Refresh the page";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = "Location information unavailable. Please check your device's location services.";
              break;
            case error.TIMEOUT:
              errorMsg = "Location request timed out. Please try again.";
              break;
            default:
              errorMsg = "Location error: " + error.message;
          }
          alert("‚ùå " + errorMsg);
        },
        { 
          enableHighAccuracy: true, 
          timeout: 10000, 
          maximumAge: 60000 
        }
      );
    }

    // Haversine Distance calculation (for proximity check)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of Earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c; // Distance in km
      return distance;
    }

  </script>
</body>
</html>