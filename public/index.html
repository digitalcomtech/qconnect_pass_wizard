<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QConnect PASS Wizard</title>
  <style>
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }
    
    /* Main layout container */
    .app-container {
      display: flex;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
      color: white;
      padding: 24px 0;
      box-shadow: 4px 0 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 10;
    }
    
    .sidebar-header {
      padding: 0 24px 24px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 24px;
    }
    
    .sidebar-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%);
      -webkit-background-clip: text;
      -webkit-background-fill-color: transparent;
      background-clip: text;
    }
    
    .sidebar-subtitle {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      margin: 0;
    }
    
    /* User Info Styles */
    .user-info {
      margin-top: 16px;
      padding: 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .user-details {
      margin-bottom: 12px;
    }
    
    .user-name {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      margin-bottom: 4px;
    }
    
    .user-role {
      display: block;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
      text-transform: capitalize;
    }
    
    .logout-btn {
      width: 100%;
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.8);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 1);
      transform: translateY(-1px);
    }
    
    /* Step navigation */
    .step-nav {
      flex: 1;
      padding: 0 16px;
    }
    
    .step-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      margin: 8px 0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      border: 2px solid transparent;
    }
    
    .step-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateX(4px);
    }
    
    .step-item.active {
      background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%);
      border-color: rgba(255,255,255,0.3);
      box-shadow: 0 4px 16px rgba(134, 43, 171, 0.3);
    }
    
    .step-item.completed {
      background: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
    }
    
    .step-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      margin-right: 16px;
      transition: all 0.2s ease;
    }
    
    .step-item.active .step-number {
      background: rgba(255,255,255,0.9);
      color: #1e293b;
    }
    
    .step-item.completed .step-number {
      background: #10b981;
      color: white;
    }
    
    .step-info {
      flex: 1;
    }
    
    .step-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin: 0 0 4px 0;
    }
    
    .step-description {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
      margin: 0;
    }
    
    .step-status {
      margin-left: 12px;
    }
    
    .step-status.completed::after {
      content: '‚úì';
      color: #10b981;
      font-weight: 700;
      font-size: 1.2rem;
    }
    
    /* Main content area */
    .main-content {
      flex: 1;
      background: #fff;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }
    
    .content-container {
      max-width: 600px;
      width: 100%;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(134, 43, 171, 0.12), 0 4px 16px rgba(0,0,0,0.08);
      padding: 40px 36px 32px 36px;
      border: 1px solid rgba(134, 43, 171, 0.1);
      position: relative;
    }
    
    /* Environment indicator in sidebar */
    .sidebar-environment {
      position: absolute;
      top: 16px;
      right: 16px;
      background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(134, 43, 171, 0.3);
      border: 2px solid rgba(255,255,255,0.2);
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-align: center;
      background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .section {
      margin-bottom: 32px;
      padding: 24px 20px 16px 20px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 2px 8px rgba(134, 43, 171, 0.06);
      width: 100%;
      position: relative;
    }
    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #862BAB 0%, #6B21A8 100%);
      border-radius: 12px 12px 0 0;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.95rem;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      box-sizing: border-box;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #862BAB;
      outline: none;
      box-shadow: 0 0 0 3px rgba(134, 43, 171, 0.1);
      transform: translateY(-1px);
    }
    button {
      padding: 12px 28px;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 0 8px 8px 0;
      box-shadow: 0 4px 12px rgba(134, 43, 171, 0.2);
      transition: all 0.2s ease;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    button:hover::before {
      left: 100%;
    }
    button:hover {
      background: linear-gradient(135deg, #6B21A8 0%, #862BAB 100%);
      box-shadow: 0 6px 20px rgba(134, 43, 171, 0.3);
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    .hidden {
      display: none;
    }
    #clientStatus,
    #vinStatus,
    #installStatus {
      margin-top: 12px;
      font-weight: 600;
      color: #dc2626;
      text-align: center;
      padding: 0;
      border-radius: 8px;
      min-height: 0;
      transition: all 0.3s ease;
    }
    
    #clientStatus:not(:empty),
    #vinStatus:not(:empty),
    #installStatus:not(:empty) {
      padding: 12px;
      min-height: 20px;
      background: rgba(220, 38, 38, 0.1);
    }
    #successMsg {
      color: #059669;
      font-size: 1.2rem;
      margin-top: 28px;
      text-align: center;
      font-weight: 600;
    }
    #imeiVerificationStatus {
      padding: 0;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      min-height: 0;
      border: none;
      transition: all 0.3s ease;
    }
    
    #imeiVerificationStatus:not(:empty) {
      padding: 12px 16px;
      min-height: 24px;
      border: 1px solid #e2e8f0;
    }
    #imeiVerificationStatus span {
      display: block;
    }
    
    /* Qualitrack-style environment indicator */
    #environmentIndicator {
      position: absolute;
      top: 16px;
      right: 16px;
      background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(134, 43, 171, 0.3);
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    /* Enhanced section headers */
    .section h2 {
      text-align: center;
      font-size: 1.3rem;
      margin-bottom: 16px;
      font-weight: 700;
      color: #1e293b;
      position: relative;
    }
    .section h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 3px;
      background: linear-gradient(90deg, #862BAB 0%, #6B21A8 100%);
      border-radius: 2px;
    }
    
    /* Qualitrack-style info boxes */
    .info-box {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      border: 1px solid #c084fc;
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      position: relative;
    }
    .info-box::before {
      content: 'üí°';
      position: absolute;
      top: -8px;
      left: 16px;
      background: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      border: 1px solid #c084fc;
    }
    
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        padding: 16px 0;
      }
      
      .step-nav {
        display: flex;
        overflow-x: auto;
        padding: 0 16px;
        gap: 12px;
      }
      
      .step-item {
        min-width: 140px;
        flex-shrink: 0;
      }
      
      .main-content {
        padding: 20px 10px;
      }
      
      .content-container {
        padding: 24px 20px;
      }
      
      .sidebar-title {
        font-size: 1.2rem;
      }
      
      .step-title {
        font-size: 0.85rem;
      }
      
      .step-description {
        font-size: 0.75rem;
      }
    }
    
    @media (max-width: 600px) {
      .step-nav {
        gap: 8px;
      }
      
      .step-item {
        min-width: 120px;
        padding: 12px 16px;
      }
      
      .step-number {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }
      
      .content-container {
        padding: 20px 16px;
      }
      
      h1 {
        font-size: 1.6rem;
      }
    }

    /* Workflow Status Bar Styles */
    .workflow-status-bar {
      background: linear-gradient(135deg, #6B21A8 0%, #862BAB 100%);
      color: white;
      padding: 12px 20px;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      justify-content: space-around;
      gap: 0;
      box-shadow: 0 2px 8px rgba(107, 33, 168, 0.2);
      border-radius: 0;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 100;
      width: 100%;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .status-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .status-value {
      font-size: 0.9rem;
      color: white;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.15);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 80px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-value:empty::after {
      content: "-";
      color: rgba(255, 255, 255, 0.6);
      font-style: italic;
    }

    .status-status {
      flex: 0 1 auto;
      min-width: 0;
    }

    .status-status .status-value {
      min-width: 120px;
      text-align: left;
      background: rgba(255, 255, 255, 0.1);
    }

    /* Responsive adjustments for status bar */
    @media (max-width: 1200px) {
      .workflow-status-bar {
        padding: 10px 16px;
        gap: 24px;
      }
      
      .status-value {
        min-width: 70px;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 1024px) {
      .workflow-status-bar {
        padding: 10px 16px;
        gap: 20px;
      }
      
      .status-value {
        min-width: 65px;
        font-size: 0.8rem;
        padding: 3px 6px;
      }
    }

    @media (max-width: 768px) {
      .workflow-status-bar {
        padding: 8px 12px;
        gap: 16px;
        flex-wrap: nowrap;
        overflow-x: auto;
        justify-content: flex-start;
      }
      
      .status-item {
        flex-shrink: 0;
        min-width: 0;
      }
      
      .status-status {
        margin-left: 0;
        flex-shrink: 0;
      }
      
      .status-value {
        font-size: 0.8rem;
        padding: 3px 6px;
        min-width: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="sidebar-environment" id="sidebarEnvironment">PROD</div>
      
      <div class="sidebar-header">
        <h1 class="sidebar-title">QConnect PASS</h1>
        <p class="sidebar-subtitle">Installation Wizard</p>
        
        <!-- User Info and Logout -->
        <div class="user-info" id="userInfo" style="display: none;">
          <div class="user-details">
            <span class="user-name" id="userName"></span>
            <span class="user-role" id="userRole"></span>
          </div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>
      
      <div class="step-nav">
        <div class="step-item active" data-step="1" id="stepNav1">
          <div class="step-number">1</div>
          <div class="step-info">
            <div class="step-title">Client Selection</div>
            <div class="step-description">Enter client name or VIN</div>
          </div>
          <div class="step-status" id="stepStatus1"></div>
        </div>
        
        <div class="step-item locked" data-step="2" id="stepNav2">
          <div class="step-number">2</div>
          <div class="step-info">
            <div class="step-title">VIN Selection</div>
            <div class="step-description">Choose installation VIN</div>
          </div>
          <div class="step-status" id="stepStatus2"></div>
        </div>
        
        <div class="step-item locked" data-step="3" id="stepNav3">
          <div class="step-number">3</div>
          <div class="step-info">
            <div class="step-title">Device Setup</div>
            <div class="step-description">Enter IMEI & SIM details</div>
          </div>
          <div class="step-status" id="stepStatus3"></div>
        </div>
        
        <div class="step-item locked" data-step="4" id="stepNav4">
          <div class="step-number">4</div>
          <div class="step-info">
            <div class="step-title">Location Check</div>
            <div class="step-description">Verify proximity to device</div>
          </div>
          <div class="step-status" id="stepStatus4"></div>
        </div>
        
        <div class="step-item locked" data-step="5" id="stepNav5">
          <div class="step-number">5</div>
          <div class="step-info">
            <div class="step-title">Form Completion</div>
            <div class="step-description">Complete installation form</div>
          </div>
          <div class="step-status" id="stepStatus5"></div>
        </div>
        
        <div class="step-item locked" data-step="6" id="stepNav6">
          <div class="step-number">6</div>
          <div class="step-info">
            <div class="step-title">Final Confirmation</div>
            <div class="step-description">Confirm installation complete</div>
          </div>
          <div class="step-status" id="stepStatus6"></div>
        </div>
      </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Status Bar - Shows accumulated information throughout the workflow -->
      <div id="workflowStatusBar" class="workflow-status-bar" style="display: none;">
        <div class="status-item">
          <span class="status-label">Step:</span>
          <span id="currentStepDisplay" class="status-value">1</span>
        </div>
        <div class="status-item">
          <span class="status-label">VIN:</span>
          <span id="currentVinDisplay" class="status-value">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">Primary:</span>
          <span id="currentPrimaryImeiDisplay" class="status-value">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">Secondary:</span>
          <span id="currentSecondaryImeiDisplay" class="status-value">-</span>
        </div>
        <div class="status-item status-status">
          <span class="status-label">Status:</span>
          <span id="currentStatusDisplay" class="status-value">Ready to start</span>
        </div>
      </div>

      <div class="content-container">
        <h1 style="text-align:center; font-size:1.8rem; margin-bottom:32px; color:#1e293b;">QConnect PASS Wizard</h1>

    <!-- STEP 1: Client Name -->
    <div id="clientSection" class="section">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 1: Enter / Select Client Name</h2>
      <form id="clientForm">
        <label for="clientNameInput">Client Name or VIN Start:</label>
        <input
          type="text"
          id="clientNameInput"
          placeholder=""
          autocomplete="off"
        />
        <button type="submit">Submit ‚ñ∂ Load VINs</button>
      </form>
      <p id="clientStatus"></p>
    </div>

    <!-- STEP 2: VIN Selection -->
    <div id="vinSection" class="section hidden">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 2: Choose a VIN (Booked)</h2>
      <div id="selectedPersonName" style="margin-bottom:10px; font-weight:bold;"></div>
      <label for="vinSelect">VIN #:</label>
      <select id="vinSelect">
        <option value="">-- Select VIN --</option>
      </select>
      <button id="backToClientBtn" type="button">‚óÄ Back</button>
      <button id="nextVinBtn">Next ‚ñ∂ Enter IMEI & SIM</button>
      <p id="vinStatus"></p>
    </div>

    <!-- STEP 3: IMEI & SIM (POST to `/api/install`) -->
    <div id="deviceSection" class="section hidden">
      <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 3: Enter IMEI & SIM</h2>
      <label for="imeiInput">IMEI (Primary Device)</label>
      <div style="display:flex; gap:8px; align-items:flex-end;">
        <input
          type="text"
          id="imeiInput"
          placeholder="Enter IMEI"
          style="flex:1;"
        />
        <button id="verifyImeiBtn" type="button" style="white-space:nowrap;">Verify IMEI</button>
      </div>
      <div id="imeiVerificationStatus" style="margin-bottom:14px;"></div>
      
      <label for="imeiConfirmInput">Retype IMEI</label>
      <input
        type="text"
        id="imeiConfirmInput"
        placeholder="Retype IMEI"
      />

      <label for="simInput">SIM Card # (Optional)</label>
      <div style="display:flex; gap:8px; align-items:flex-end;">
        <input
          type="text"
          id="simInput"
          placeholder="Leave blank if no SIM card"
          style="flex:1;"
        />
        <button id="verifySimBtn" type="button" style="white-space:nowrap;">Verify SIM</button>
      </div>
      <div id="simVerificationStatus" style="margin-bottom:14px;"></div>
      
      <label for="simConfirmInput">Retype SIM Card # (Optional)</label>
      <input
        type="text"
        id="simConfirmInput"
        placeholder="Retype SIM Card # (optional)"
      />

      <label style="display:flex;align-items:center;margin-bottom:8px;">
        <input type="checkbox" id="addSecondaryUnit" style="margin-right:8px;" />
        Add Secondary Unit (IMEI)
      </label>
      <div id="secondaryUnitFields" class="hidden" style="width:100%;">
        <label for="secondaryImeiInput">Secondary IMEI</label>
        <input type="text" id="secondaryImeiInput" placeholder="Enter secondary IMEI" />
      </div>

      <button id="backToVinBtn" type="button">‚óÄ Back</button>
      <button id="startInstallBtn" type="button" disabled>Start Installation ‚ñ∂</button>
      
      <div class="info-box" style="margin-top: 16px; margin-bottom: 16px;">
        <div style="font-weight: 600; color: #6B21A8; margin-bottom: 8px; font-size: 1rem;">üìç Location Verification</div>
        <div style="font-size: 0.9rem; color: #374151; margin-bottom: 12px;">
          The app will verify your location is within 200 meters of the device before proceeding with installation.
        </div>
        
        <!-- Test Mode Location Spoofing -->
        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0;">
          <label style="display:flex;align-items:center;margin-bottom:12px;cursor:pointer;">
            <input type="checkbox" id="enableTestMode" style="margin-right:10px; transform: scale(1.2);" />
            <span style="font-weight: 600; color: #ea580c; font-size: 1rem;">üß™ Enable Test Mode (Location Spoofing)</span>
          </label>
          <div id="testModeFields" class="hidden" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 10px; padding: 16px; margin-top: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
            <div style="font-size: 0.95rem; color: #92400e; margin-bottom: 12px; font-weight: 600;">
              üí° <strong>Test Mode:</strong> Enter custom coordinates to simulate being at the installation location
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div>
                <label for="testLatInput" style="font-size: 0.9rem; color: #92400e; font-weight: 600;">Test Latitude:</label>
                <input type="number" id="testLatInput" placeholder="e.g., 25.78395" step="0.00001" style="font-size: 0.9rem; padding: 10px 12px; border: 2px solid #f59e0b; border-radius: 8px; background: #fff;" />
              </div>
              <div>
                <label for="testLonInput" style="font-size: 0.9rem; color: #92400e; font-weight: 600;">Test Longitude:</label>
                <input type="number" id="testLonInput" placeholder="e.g., -100.26345" step="0.00001" style="font-size: 0.9rem; padding: 10px 12px; border: 2px solid #f59e0b; border-radius: 8px; background: #fff;" />
              </div>
            </div>
            <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.6); border-radius: 8px; border: 1px solid #f59e0b;">
              <strong>Current Device Location:</strong> 
              <span id="deviceLocationDisplay" style="font-weight: 600; color: #6B21A8;">Loading...</span>
              <button id="copyDeviceLocationBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); color: white; border: none; border-radius: 6px; padding: 6px 10px; margin-left: 12px; font-size: 0.8rem; cursor: pointer; font-weight: 600; box-shadow: 0 2px 6px rgba(134, 43, 171, 0.3);">
                üìã Copy to Test Fields
              </button>
            </div>
            <div style="font-size: 0.85rem; color: #92400e; margin-top: 12px; padding-top: 12px; border-top: 2px solid #f59e0b;">
              üéØ <strong>How to use:</strong> 
              <ol style="margin: 6px 0 6px 20px; padding: 0; line-height: 1.5;">
                <li>Check "Enable Test Mode" above</li>
                <li>Wait for device to report location (or use "Copy to Test Fields")</li>
                <li>Modify coordinates slightly to test proximity logic</li>
                <li>Start installation - app will use your test coordinates</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <p id="installStatus"></p>
    </div>

        <!-- STEP 4: Location Check & Form -->
        <div id="locationSection" class="section hidden">
          <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 4: Location Verification & Form</h2>
          <div id="locationStatus"></div>
        </div>

        <!-- STEP 5: Form Completion -->
        <div id="formSection" class="section hidden">
          <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 5: Complete Installation Form</h2>
          <div id="formStatus"></div>
        </div>

        <!-- STEP 6: Final Confirmation -->
        <div id="confirmationSection" class="section hidden">
          <h2 style="text-align:center; font-size:1.2rem; margin-bottom:12px;">Step 6: Finalize Installation</h2>
          <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:1.1rem; margin-bottom:10px;">‚úÖ Form has been submitted successfully!</div>
            <div style="font-size:0.95rem; color:#666; margin-bottom:20px;">
              Please confirm that the installation is complete and all checks have been performed.
            </div>
            <div class="info-box" style="margin: 0 20px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #10b981;">
              üí° <strong>Note:</strong> Make sure you have completed the installation form that was opened earlier before proceeding with this final confirmation.
            </div>
          </div>
          
          <div class="info-box" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #64748b; margin-bottom: 20px;">
            <h3 style="margin:0 0 12px 0; font-size:1.1rem; color:#1e293b; font-weight: 700;">Installation Checklist:</h3>
            <div style="font-size:0.95rem; color:#475569; line-height: 1.6;">
              ‚òëÔ∏è Device properly mounted and connected<br>
              ‚òëÔ∏è Power connections verified<br>
              ‚òëÔ∏è Ignition wire connected<br>
              ‚òëÔ∏è Input/Output connections tested<br>
              ‚òëÔ∏è Device reporting location successfully
            </div>
          </div>

          <div style="text-align:center;">
            <button id="finalConfirmBtn" type="button" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); font-size:1.1rem; padding:14px 32px; box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);">
              üîí Confirm & Finalize Installation
            </button>
            <div id="confirmationStatus" style="margin-top:15px; font-weight:600;"></div>
          </div>
        </div>

        <!-- FINAL Success Message -->
        <div id="successMsg" style="display:none; text-align:center; margin-top:32px;">
          <div style="font-size:5rem; color:#059669; margin-bottom:20px; text-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">&#10004;</div>
          <div style="font-size:1.5rem; font-weight:700; color:#059669; margin-bottom:12px; text-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);">Installation Complete!</div>
          <div style="font-size:1.1rem; color:#374151; line-height: 1.6;">Thank you for using the QConnect PASS Wizard.<br>You may now close this window.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Authentication check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Verify token is valid
      fetch('/api/auth/me', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          localStorage.removeItem('authToken');
          window.location.href = '/login.html';
        }
      })
      .catch(() => {
        localStorage.removeItem('authToken');
        window.location.href = '/login.html';
      });
    })();
    
    sessionStorage.clear();
    // DOM references
    const clientSection       = document.getElementById("clientSection");
    const clientForm          = document.getElementById("clientForm");
    const clientNameInput     = document.getElementById("clientNameInput");
    const clientStatus        = document.getElementById("clientStatus");

    const vinSection          = document.getElementById("vinSection");
    const vinSelect           = document.getElementById("vinSelect");
    const nextVinBtn          = document.getElementById("nextVinBtn");
    const backToClientBtn     = document.getElementById("backToClientBtn");
    const vinStatus           = document.getElementById("vinStatus");

    const deviceSection       = document.getElementById("deviceSection");
    const imeiInput           = document.getElementById("imeiInput");
    const simInput            = document.getElementById("simInput");
    const startInstallBtn     = document.getElementById("startInstallBtn");
    const backToVinBtn        = document.getElementById("backToVinBtn");
    const installStatus       = document.getElementById("installStatus");
    const verifyImeiBtn       = document.getElementById("verifyImeiBtn");
    const imeiVerificationStatus = document.getElementById("imeiVerificationStatus");

    const confirmationSection = document.getElementById("confirmationSection");
    const finalConfirmBtn     = document.getElementById("finalConfirmBtn");
    const confirmationStatus  = document.getElementById("confirmationStatus");
    const successMsg          = document.getElementById("successMsg");

    // State
    let selectedClientName    = "";
    let selectedVIN           = "";
    let selectedInstallationId = "";
    let imeiVerified          = false;
    let simVerified           = false;
    let appConfig             = null;
    let formAlreadyOpened     = false; // Prevent form from opening multiple times

    document.addEventListener("DOMContentLoaded", async () => {
      // Setup user info and logout
      setupUserInfo();
      
      // Check geolocation support
      if (!navigator.geolocation) {
        console.warn("Geolocation not supported by this browser");
        // Add a warning to the UI
        const locationWarning = document.createElement("div");
        locationWarning.style.cssText = "background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; padding: 8px; margin: 8px 0; color: #721c24; font-size: 0.9rem;";
        locationWarning.innerHTML = "‚ö†Ô∏è Geolocation not supported by your browser. You'll need to use manual location override.";
        document.querySelector(".content-container").insertBefore(locationWarning, document.getElementById("clientSection"));
      }
      
      // Load app configuration first
      await loadAppConfig();
      
      // Initialize sidebar navigation
      initializeSidebarNavigation();
      
      clientForm.addEventListener("submit", onNextClient);
      nextVinBtn.addEventListener("click", onNextVin);
      startInstallBtn.addEventListener("click", onStartInstallation);
      verifyImeiBtn.addEventListener("click", onVerifyImei);
      verifySimBtn.addEventListener("click", onVerifySim);
      
      // Reset verification when IMEI changes
      imeiInput.addEventListener("input", () => {
        if (imeiVerified) {
          imeiVerified = false;
          startInstallBtn.disabled = true;
          imeiVerificationStatus.innerHTML = '<span style="color:#f39c12;">‚ö†Ô∏è IMEI changed - please verify again</span>';
        }
      });
      
      // Reset verification when SIM changes
      simInput.addEventListener("input", () => {
        if (simVerified) {
          simVerified = false;
          simVerificationStatus.innerHTML = '<span style="color:#f39c12;">‚ö†Ô∏è SIM changed - please verify again</span>';
        }
      });
      
      document.getElementById("addSecondaryUnit").addEventListener("change", function(e) {
        document.getElementById("secondaryUnitFields").classList.toggle("hidden", !e.target.checked);
      });
      
      // Test mode toggle
      document.getElementById("enableTestMode").addEventListener("change", function(e) {
        document.getElementById("testModeFields").classList.toggle("hidden", !e.target.checked);
        if (e.target.checked) {
          updateDeviceLocationDisplay();
        }
      });
      
      // Copy device location to test fields
      document.addEventListener("click", function(e) {
        if (e.target.id === "copyDeviceLocationBtn") {
          const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
          const deviceLat = inst.vehiculo?.latest?.loc?.lat;
          const deviceLon = inst.vehiculo?.latest?.loc?.lon;
          
          if (deviceLat && deviceLon) {
            document.getElementById("testLatInput").value = deviceLat.toFixed(5);
            document.getElementById("testLonInput").value = deviceLon.toFixed(5);
            e.target.textContent = "‚úÖ Copied!";
            setTimeout(() => {
              e.target.textContent = "üìã Copy to Test Fields";
            }, 2000);
          } else {
            alert("Device location not available yet. Please wait for the device to report its location.");
          }
        }
      });
      
      // Final confirmation button
      finalConfirmBtn.addEventListener("click", onFinalConfirmation);
      
      restoreState();
    });

    // Load app configuration
    async function loadAppConfig() {
      try {
        const resp = await fetch("/api/config", {
          headers: getAuthHeaders()
        });
        appConfig = await resp.json();
        console.log(`üîß Frontend loaded ${appConfig.environment.toUpperCase()} environment config`);
        
        // Update page title and sidebar indicator to show environment
        const envIndicator = document.getElementById("sidebarEnvironment");
        if (appConfig.environment === "qa") {
          document.title = "QConnect PASS Wizard (QA)";
          document.querySelector(".content-container h1").textContent = "QConnect PASS Wizard (QA)";
          envIndicator.textContent = "QA";
          envIndicator.style.background = "linear-gradient(135deg, #f59e0b 0%, #d97706 100%)";
        } else {
          document.title = "QConnect PASS Wizard";
          document.querySelector(".content-container h1").textContent = "QConnect PASS Wizard";
          envIndicator.style.background = "linear-gradient(135deg, #862BAB 0%, #6B21A8 100%)";
        }
      } catch (err) {
        console.error("Failed to load app config:", err);
        // Fallback to production config
        appConfig = {
          environment: "production",
          testMode: false,
          pegasusBaseUrl: "https://qservices.pegasusgateway.com",
          pegasusToken: "2f2df11d24bba3d071c22ca1c54f42dd64dda64e6bddfe9e6f3cc824"
        };
      }
    }
    
    // Initialize sidebar navigation
    function initializeSidebarNavigation() {
      // Add click event listeners to all step navigation items
      document.querySelectorAll('.step-item').forEach(stepItem => {
        stepItem.addEventListener('click', function() {
          const step = this.getAttribute('data-step');
          if (!this.classList.contains('locked')) {
            navigateToStep(parseInt(step));
          }
        });
      });
    }
    
    // Navigate to a specific step
    function navigateToStep(stepNumber) {
      // Hide all sections first
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Remove active class from all step nav items
      document.querySelectorAll('.step-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show the selected step
      let targetSection;
      switch(stepNumber) {
        case 1:
          targetSection = document.getElementById('clientSection');
          break;
        case 2:
          targetSection = document.getElementById('vinSection');
          break;
        case 3:
          targetSection = document.getElementById('deviceSection');
          break;
        case 4:
          targetSection = document.getElementById('locationSection');
          break;
        case 5:
          targetSection = document.getElementById('formSection');
          break;
        case 6:
          targetSection = document.getElementById('confirmationSection');
          break;
        default:
          targetSection = document.getElementById('clientSection');
      }
      
      if (targetSection) {
        targetSection.classList.remove('hidden');
        // Update active step in sidebar
        document.getElementById(`stepNav${stepNumber}`).classList.add('active');
        // Store current step in session
        sessionStorage.setItem("currentStep", stepNumber.toString());
      }
    }
    
    // Update step status in sidebar
    function updateStepStatus(stepNumber, status) {
      const stepNav = document.getElementById(`stepNav${stepNumber}`);
      const stepStatus = document.getElementById(`stepStatus${stepNumber}`);
      
      if (stepNav && stepStatus) {
        // Remove all status classes
        stepNav.classList.remove('locked', 'completed');
        stepStatus.classList.remove('completed');
        
        // Apply new status
        switch(status) {
          case 'completed':
            stepNav.classList.add('completed');
            stepStatus.classList.add('completed');
            break;
          case 'active':
            stepNav.classList.add('active');
            break;
          case 'locked':
            stepNav.classList.add('locked');
            break;
        }
      }
    }
    
    // Unlock next step
    function unlockNextStep(currentStep) {
      if (currentStep < 6) {
        const nextStep = currentStep + 1;
        const nextStepNav = document.getElementById(`stepNav${nextStep}`);
        if (nextStepNav) {
          nextStepNav.classList.remove('locked');
        }
      }
    }

    // STEP 1 ‚Üí STEP 2
    async function onNextClient(e) {
      e.preventDefault();
      clientStatus.innerText = "";

      // Clear previous workflow status and start fresh (only if status bar exists)
      if (document.getElementById('workflowStatusBar')) {
        clearWorkflowStatus();
        updateWorkflowStatus({
          currentStep: '1',
          status: 'Starting new workflow...'
        });
      }

      selectedClientName = clientNameInput.value.trim();
      if (!selectedClientName) {
        clientStatus.innerText = "üö® Please enter a client name or VIN start.";
        return;
      }
      clientStatus.innerText = "‚Üª Fetching all installations‚Ä¶";

      try {
        const resp = await fetch(
          `/api/search-installations?query=${encodeURIComponent(selectedClientName)}`,
          {
            headers: getAuthHeaders()
          }
        );
        if (!resp.ok) throw new Error(`Search failed: ${resp.status}`);
        const data = await resp.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Search failed');
        }
        
        const installationsArray = data.installations;
        const filtered = installationsArray; // Already filtered by backend

        if (filtered.length === 0) {
          clientStatus.innerText = `‚ùå No installations found for "${selectedClientName}".`;
          vinSelect.innerHTML = `<option value="">-- No VINs found --</option>`;
          return;
        }

        vinSelect.innerHTML = `<option value="">-- Select VIN --</option>`;
        // Store the full filtered array for later use
        sessionStorage.setItem("filteredInst", JSON.stringify(filtered));

        filtered.forEach(inst => {
          const vin = inst.vehiculo?.serie;
          if (!vin) return;
          const p = inst.persona || {};
          const fullName = [p.nombreAsegurado, p.nombreMedioAsegurado, p.apellidoPaterno, p.apellidoMaterno].filter(Boolean).join(" ");
          const opt = document.createElement("option");
          opt.value = vin;
          opt.textContent = `${vin} ‚Äî ${fullName}`;
          opt.dataset.installationId = inst._id;
          vinSelect.appendChild(opt);
        });

        // Persist
        sessionStorage.setItem("step", "2");
        sessionStorage.setItem("clientName", selectedClientName);

        // Update workflow status
        updateWorkflowStatus({
          currentStep: '2',
          status: `Found ${filtered.length} installation(s) for "${selectedClientName}"`
        });

        // Update sidebar and navigate to step 2
        updateStepStatus(1, 'completed');
        unlockNextStep(1);
        navigateToStep(2);

        debugPrint(filtered, "Filtered Installations");
      } catch (err) {
        console.error(err);
        clientStatus.innerText = "‚ùå " + err.message;
      }
    }

    // STEP 2 ‚Üí STEP 3
    function onNextVin() {
      vinStatus.innerText = "";
      const vin = vinSelect.value;
      if (!vin) {
        vinStatus.innerText = "üö® Please select a VIN.";
        return;
      }
      selectedVIN = vin;
      selectedInstallationId = vinSelect.selectedOptions[0].dataset.installationId;

      sessionStorage.setItem("step", "3");
      sessionStorage.setItem("selectedVIN", selectedVIN);
      sessionStorage.setItem("installationId", selectedInstallationId);

      // Update workflow status
      updateWorkflowStatus({
        currentStep: '3',
        vin: selectedVIN,
        status: `Selected VIN: ${selectedVIN}`
      });

      // Update sidebar and navigate to step 3
      updateStepStatus(2, 'completed');
      unlockNextStep(2);
      navigateToStep(3);

      const filtered = JSON.parse(sessionStorage.getItem("filteredInst") || "[]");
      const inst = filtered.find(inst => inst.vehiculo?.serie === vin);
      let personName = "";
      if (inst && inst.persona) {
        const p = inst.persona;
        personName = [p.nombreAsegurado, p.nombreMedioAsegurado, p.apellidoPaterno, p.apellidoMaterno]
          .filter(Boolean).join(" ");
        sessionStorage.setItem("selectedClientFullName", personName);
      }

      if (inst) {
        // Store the full installation object for later use (for device location)
        sessionStorage.setItem("selectedInstallation", JSON.stringify(inst));
      }
    }

    // IMEI Verification
    async function onVerifyImei() {
      const imei = imeiInput.value.trim();
      if (!imei) {
        imeiVerificationStatus.innerHTML = '<span style="color:#e74c3c;">üö® Please enter an IMEI to verify.</span>';
        return;
      }

      imeiVerificationStatus.innerHTML = '<span style="color:#f39c12;">‚è≥ Verifying IMEI...</span>';
      verifyImeiBtn.disabled = true;

      try {
        const resp = await fetch("/api/verify-imei", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ imei })
        });

        const data = await resp.json();

        if (resp.ok && data.success) {
          imeiVerified = true;
          startInstallBtn.disabled = false;
          imeiVerificationStatus.innerHTML = `<span style="color:#27ae60;">‚úÖ IMEI verified successfully! Device state: ${data.deviceState}</span>`;
          
          // Update workflow status
          updateWorkflowStatus({
            primaryImei: imei,
            status: `Primary IMEI verified: ${data.deviceState}`
          });
        } else {
          imeiVerified = false;
          startInstallBtn.disabled = true;
          imeiVerificationStatus.innerHTML = `<span style="color:#e74c3c;">‚ùå ${data.message}</span>`;
        }
      } catch (err) {
        console.error("Error verifying IMEI:", err);
        imeiVerified = false;
        startInstallBtn.disabled = true;
        imeiVerificationStatus.innerHTML = '<span style="color:#e74c3c;">‚ùå Error connecting to verification service</span>';
      } finally {
        verifyImeiBtn.disabled = false;
      }
    }
    
    // SIM Verification
    async function onVerifySim() {
      const iccid = simInput.value.trim();
      if (!iccid) {
        simVerificationStatus.innerHTML = '<span style="color:#e74c3c;">üö® Please enter an ICCID to verify.</span>';
        return;
      }

      simVerificationStatus.innerHTML = '<span style="color:#f39c12;">‚è≥ Verifying SIM...</span>';
      verifySimBtn.disabled = true;

      try {
        const resp = await fetch("/api/verify-sim", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ iccid })
        });

        const data = await resp.json();

        if (resp.ok && data.success) {
          simVerified = true;
          simVerificationStatus.innerHTML = `<span style="color:#27ae60;">‚úÖ ${data.simData.simType} SIM verified successfully! Found in ${data.simData.foundIn} | Status: ${data.simData.status}</span>`;
        } else {
          simVerified = false;
          simVerificationStatus.innerHTML = `<span style="color:#e74c3c;">‚ùå ${data.message}</span>`;
        }
      } catch (err) {
        console.error("Error verifying SIM:", err);
        simVerified = false;
        simVerificationStatus.innerHTML = '<span style="color:#e74c3c;">‚ùå Error connecting to verification service</span>';
      } finally {
        verifySimBtn.disabled = false;
      }
    }

    // STEP 3 ‚Üí STEP 4
    async function onStartInstallation() {
      installStatus.innerText = "";
      
      // Reset form opened flag for new installation
      formAlreadyOpened = false;
      
      // Check if IMEI has been verified
      if (!imeiVerified) {
        installStatus.innerText = "üö® Please verify the IMEI before proceeding with installation.";
        return;
      }
      
      const imei = imeiInput.value.trim();
      const imeiConfirm = document.getElementById("imeiConfirmInput").value.trim();
      const sim = simInput.value.trim();
      const simConfirm = document.getElementById("simConfirmInput").value.trim();
      const secondaryImei = document.getElementById("secondaryImeiInput").value.trim();
      const addSecondary = document.getElementById("addSecondaryUnit").checked;
      
      if (!imei) {
        installStatus.innerText = "üö® Please enter IMEI.";
        return;
      }
      if (imei !== imeiConfirm) {
        installStatus.innerText = "üö® IMEI values do not match.";
        return;
      }
      
      // Validate SIM if provided
      if (sim) {
        if (sim !== simConfirm) {
          installStatus.innerText = "üö® SIM values do not match.";
          return;
        }
        if (!simVerified) {
          installStatus.innerText = "üö® Please verify the SIM card before proceeding with installation.";
          return;
        }
      }
      
      if (addSecondary && !secondaryImei) {
        installStatus.innerText = "üö® Please enter the secondary IMEI.";
        return;
      }
      installStatus.innerText = "‚Üª Sending IMEI & SIM to server‚Ä¶";

      try {
        const payload = {
          client_name: sessionStorage.getItem("selectedClientFullName") || selectedClientName,
          imei,
          vin: selectedVIN,
          installationId: selectedInstallationId
        };
        // Only include SIM if provided
        if (sim) {
          payload.sim_number = sim;
        }
        if (addSecondary && secondaryImei) {
          payload.secondary_imei = secondaryImei;
        }
        const resp = await fetch("/api/install", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== "success") throw new Error(data.message || `Status: ${data.status}`);

        sessionStorage.setItem("step", "waitingForDevice");
        
        // Update workflow status for device monitoring
        updateWorkflowStatus({
          currentStep: '4',
          status: 'Monitoring device location...'
        });
        
        const testModeNote = document.getElementById("enableTestMode").checked ? 
          '<div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-top: 12px; color: #92400e;">üß™ <strong>Test Mode Active:</strong> Will use custom coordinates instead of GPS</div>' : '';
        
        installStatus.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-size: 1.2rem; color: #6B21A8; margin-bottom: 12px; font-weight: 700;">
              ‚è≥ Starting device location monitoring...
            </div>
            <div style="font-size: 0.95rem; color: #475569; margin-bottom: 12px; line-height: 1.5;">
              <strong>Initial interval:</strong> 10 seconds | <strong>Maximum duration:</strong> 30 minutes
            </div>
            <div class="info-box" style="margin-bottom: 12px;">
              üí° <strong>Smart polling:</strong> We'll check less frequently over time to avoid overwhelming the system.
            </div>
            ${testModeNote}
          </div>
          <button id="stopPollingBtn" type="button" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-top: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">üõë Stop Waiting</button>
        `;

        // Initialize polling control
        window.stopPolling = false;

        // Add stop polling functionality
        document.getElementById("stopPollingBtn").addEventListener("click", () => {
          window.stopPolling = true;
          installStatus.innerHTML = "üõë Stopped waiting for device. You can restart the installation process.";
        });

        // Update sidebar: Step 3 completed, unlock Step 4
        updateStepStatus(3, 'completed');
        unlockNextStep(3);
        
        // Start polling for device status
        pollForDeviceReporting();
      } catch (err) {
        console.error(err);
        installStatus.innerText = "‚ùå " + err.message;
      }
    }

    function pollForDeviceReporting() {
      // Steady polling at 1 per minute
      const MAX_DURATION = 30 * 60 * 1000; // 30 minutes total
      const STEADY_INTERVAL = 60000; // Steady 1 minute between checks
      
      let attempts = 0;
      let currentInterval = STEADY_INTERVAL;
      let startTime = Date.now();
      let lastLocationCheck = null;
      let consecutiveLocationFailures = 0;
      const MAX_CONSECUTIVE_FAILURES = 3; // Allow some wrong locations before giving up

      // Update the status display with better information
      function updateStatusDisplay() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const nextCheckIn = Math.ceil(currentInterval / 1000);
        
        installStatus.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-size: 1.2rem; color: #6B21A8; margin-bottom: 12px; font-weight: 700;">
              ‚è≥ Waiting for device to report location...
            </div>
            <div style="font-size: 0.95rem; color: #475569; margin-bottom: 10px; line-height: 1.5;">
              <strong>Elapsed time:</strong> ${timeStr} | <strong>Next check in:</strong> ${nextCheckIn}s
            </div>
            <div style="font-size: 0.95rem; color: #475569; margin-bottom: 12px; line-height: 1.5;">
              <strong>Attempts:</strong> ${attempts} | <strong>Current interval:</strong> ${Math.ceil(currentInterval/1000)}s
            </div>
            <div class="info-box" style="margin-bottom: 12px;">
              üí° <strong>Tip:</strong> Device may take up to 30 minutes to report. We'll check every minute at a steady pace.
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; color: #92400e;">
              üîç <strong>Enhanced Requirements:</strong> Device must be online, have recent connection data (‚â§5min), recent network activity (‚â§5min), AND fresh location data (‚â§60s old)
            </div>
          </div>
          <button id="stopPollingBtn" type="button" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-top: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">üõë Stop Waiting</button>
                      <button id="forceLocationCheckBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-left: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîç Check Now</button>
        `;

        // Add event listeners for the new buttons
        document.getElementById("stopPollingBtn").addEventListener("click", () => {
          window.stopPolling = true;
          installStatus.innerHTML = "üõë Stopped waiting for device. You can restart the installation process.";
        });

        document.getElementById("forceLocationCheckBtn").addEventListener("click", () => {
          // Force an immediate check
          currentInterval = 1000; // Check in 1 second
          checkStatus();
        });
      }

      async function checkStatus() {
        // Check if polling was stopped
        if (window.stopPolling) {
          console.log("Polling stopped by user");
          return;
        }

        // Check if we've exceeded the maximum duration
        if (Date.now() - startTime > MAX_DURATION) {
          installStatus.innerHTML = `
            <div style="color: #dc2626; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚è∞ Time limit reached (30 minutes)</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                The device has not reported location within the expected timeframe. This could indicate:
              </div>
              <ul style="font-size: 0.95rem; margin-bottom: 16px; padding-left: 24px; line-height: 1.6;">
                <li>Device is not properly connected or powered</li>
                <li>Network connectivity issues</li>
                <li>Device configuration problems</li>
              </ul>
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 16px; color: #92400e;">
              <strong>Options:</strong>
              <div style="margin-top: 12px;">
                <button id="retryPollingBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-right: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîÑ Restart Polling</button>
              </div>
            </div>
          `;

          // Add event listeners for the options
          document.getElementById("retryPollingBtn").addEventListener("click", () => {
            startTime = Date.now();
            attempts = 0;
            currentInterval = STEADY_INTERVAL;
            consecutiveLocationFailures = 0;
            checkStatus();
          });

          return;
        }

        attempts++;
        console.log(`Checking device status (attempt ${attempts}, interval: ${Math.ceil(currentInterval/1000)}s)...`);
        
        // Update status display
        updateStatusDisplay();

        try {
                  // Call backend endpoint to check device status
        const resp = await fetch(`/api/device-status?imei=${encodeURIComponent(imeiInput.value.trim())}`, {
          headers: getAuthHeaders()
        });
        const data = await resp.json();
        
        // Log detailed device status for debugging
        console.log("Device status check:", {
          isReporting: data.isReporting,
          hasValidLocation: data.latest?.loc?.lat != null && data.latest?.loc?.lon != null && (data.latest?.loc?.age || 0) <= 60,
          isOnline: data.connection?.online,
          connectionState: data.connection?.state,
          locationAge: data.latest?.loc?.age,
          locationData: data.latest?.loc
        });
        
        // Also log the full response for debugging
        console.log("Full device status response:", data);

          // Enhanced validation using backend analysis
          const isDeviceOnline = data.isOnline === true;
          // Use the same logic as the backend: check if coordinates exist and are fresh
          const hasValidLocation = data.latest?.loc?.lat != null && data.latest?.loc?.lon != null && (data.latest?.loc?.age || 0) <= 60;
          const locationAge = data.latest?.loc?.age || 0; // Age in seconds
          const hasRecentConnection = data.hasRecentConnection === true;
          const hasRecentActivity = data.hasRecentActivity === true;
          
          // Debug: Log each validation check individually
          console.log("üîç VALIDATION DEBUG:", {
            isReporting: data.isReporting,
            hasValidLocation,
            isDeviceOnline,
            hasRecentConnection,
            hasRecentActivity,
            locationAge,
            dataKeys: Object.keys(data)
          });
          
          // Update device location display for test mode
          if (document.getElementById("enableTestMode").checked) {
            updateDeviceLocationDisplay();
          }
          
          // Comprehensive validation - ALL conditions must be true
          if (data.isReporting && hasValidLocation && isDeviceOnline && hasRecentConnection && hasRecentActivity && locationAge <= 60) {
            console.log("Device is online and reporting fresh location, checking proximity...");
            
            // Update workflow status
            updateWorkflowStatus({
              status: `Device ready! Location age: ${locationAge}s`
            });
            
            // Get device location data
            const deviceLat = data.latest.loc.lat;
            const deviceLon = data.latest.loc.lon;

            if (deviceLat == null || deviceLon == null) {
              console.log("Device location data incomplete, continuing to poll...");
              scheduleNextCheck();
              return;
            }

            // Check if this is a reasonable location (not obviously wrong)
            if (Math.abs(deviceLat) > 90 || Math.abs(deviceLon) > 180) {
              console.log("Device reported invalid coordinates, continuing to poll...");
              scheduleNextCheck();
              return;
            }

            // Check location age - if it's very old, it might be stale data
            if (locationAge > 300) { // 5 minutes old
              console.log(`Device location is ${locationAge}s old, might be stale. Continuing to poll...`);
              scheduleNextCheck();
              return;
            }

            // Now check user proximity to device (only if form hasn't been opened yet)
            if (!formAlreadyOpened) {
              await checkUserProximity(deviceLat, deviceLon);
            } else {
              console.log("Form already opened, skipping proximity check");
              scheduleNextCheck();
            }
            
          } else {
            // Enhanced logging showing exactly why each check failed
            console.log("üîç Device validation failed - analyzing reasons:");
            
            if (!data.isReporting) {
              console.log("‚ùå Device not reporting data yet");
            } else {
              console.log("‚úÖ Device is reporting data");
            }
            
            if (!hasValidLocation) {
              console.log("‚ùå Device data available but no valid location");
            } else {
              console.log("‚úÖ Device has valid location");
            }
            
            if (!isDeviceOnline) {
              console.log("‚ùå Device has location but is offline");
            } else {
              console.log("‚úÖ Device connection is online");
            }
            
            if (!hasRecentConnection) {
              console.log("‚ùå Device connection data is stale (>5 minutes old)");
            } else {
              console.log("‚úÖ Device has recent connection data");
            }
            
            if (!hasRecentActivity) {
              console.log("‚ùå Device has no recent network activity (>5 minutes)");
            } else {
              console.log("‚úÖ Device has recent network activity");
            }
            
            if (locationAge > 60) {
              console.log(`‚ùå Device location is too old (${locationAge}s > 60s)`);
            } else {
              console.log(`‚úÖ Device location is fresh (${locationAge}s ‚â§ 60s)`);
            }
            
            console.log("üìä Summary:", {
              isReporting: data.isReporting,
              hasValidLocation,
              isDeviceOnline,
              hasRecentConnection,
              hasRecentActivity,
              locationAge,
              dataFreshness: data.dataFreshness
            });
            
            scheduleNextCheck();
          }

        } catch (error) {
          console.error("Error checking device status:", error);
          // Don't stop polling on errors, just continue
          scheduleNextCheck();
        }
      }

              // Function to check user proximity to device
        async function checkUserProximity(deviceLat, deviceLon) {
          // Double-check to prevent multiple form openings
          if (formAlreadyOpened) {
            console.log("Form already opened, skipping proximity check");
            return;
          }
          
          try {
            // Check if test mode is enabled
            const testModeEnabled = document.getElementById("enableTestMode").checked;
            
            if (testModeEnabled) {
              // Use test coordinates
              const testLat = parseFloat(document.getElementById("testLatInput").value);
              const testLon = parseFloat(document.getElementById("testLonInput").value);
              
              if (isNaN(testLat) || isNaN(testLon)) {
                console.log("Test coordinates not entered, continuing to poll...");
                scheduleNextCheck();
                return;
              }
              
              console.log(`üß™ Test Mode: Using coordinates ${testLat}, ${testLon}`);
              console.log(`üß™ Device coordinates: ${deviceLat}, ${deviceLon}`);
              const distance = haversineDistance(testLat, testLon, deviceLat, deviceLon);
              console.log(`üß™ Calculated distance: ${distance.toFixed(2)}m`);
              
              if (distance < 200) {
                handleProximitySuccess("Test Mode");
              } else {
                handleProximityFailure(distance, "Test Mode");
              }
            } else {
              // Use GPS location
              navigator.geolocation.getCurrentPosition(
                function(position) {
                  const userLat = position.coords.latitude;
                  const userLon = position.coords.longitude;
                  const distance = haversineDistance(userLat, userLon, deviceLat, deviceLon);
                  
                  if (distance < 200) {
                    handleProximitySuccess("GPS");
                  } else {
                    handleProximityFailure(distance, "GPS");
                  }
                },
                function(error) {
                  console.log("GPS error, showing manual location options...");
                  showManualLocationOverride(deviceLat, deviceLon);
                },
                { 
                  enableHighAccuracy: true, 
                  timeout: 15000, 
                  maximumAge: 60000 
                }
              );
            }

        } catch (error) {
          console.error("Error in proximity check:", error);
          scheduleNextCheck();
        }
      }

      // Handle successful proximity check
      function handleProximitySuccess(method) {
        // Prevent multiple form openings
        if (formAlreadyOpened) {
          console.log("Form already opened, skipping duplicate call");
          return;
        }
        
        console.log(`Proximity check successful via ${method}`);
        formAlreadyOpened = true; // Set flag to prevent multiple openings
        
        const testModeIndicator = method === "Test Mode" ? 
          '<div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 16px; color: #92400e;">üß™ <strong>Test Mode Active:</strong> Using custom coordinates for proximity check</div>' : '';
        
        installStatus.innerHTML = `
          <div style="color: #059669; margin-bottom: 20px;">
            <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚úÖ Location check passed!</div>
            <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
              You are within 200 meters of the device. Opening installation form...
            </div>
            ${testModeIndicator}
          </div>
        `;
        
        setTimeout(() => {
          console.log("Opening prefilled form...");
          openPrefilledForm();
          console.log("Form opened successfully");
          
          // Update sidebar: Step 4 completed, unlock Step 5
          updateStepStatus(4, 'completed');
          unlockNextStep(4);
          
          // Show form completion interface
          installStatus.innerHTML = `
            <div style="color: #059669; margin-bottom: 12px; font-weight: 700;">‚úÖ Location check passed!</div>
            <div class="info-box" style="margin-bottom: 12px;">
              <div style="font-weight: 700; color: #6B21A8; margin-bottom: 10px; font-size: 1rem;">üìã Form Opened</div>
              <div style="font-size: 0.95rem; color: #374151; margin-bottom: 16px; line-height: 1.5;">
                The installation form has been opened in a new tab. Please complete the form, then return here and click the button below to continue.
              </div>
              <button id="formCompletedBtn" type="button" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">
                ‚úÖ I've Completed the Form - Continue to Confirmation
              </button>
            </div>
          `;
          
          // Add event listener for the form completion button
          document.getElementById("formCompletedBtn").addEventListener("click", function() {
            // Check if secondary device needs to be processed
            const addSecondary = document.getElementById("addSecondaryUnit").checked;
            const secondaryImei = document.getElementById("secondaryImeiInput").value.trim();
            
            if (addSecondary && secondaryImei && window.secondaryImeiVerified) {
              // Start secondary device workflow (Steps 35-40)
              startSecondaryDeviceWorkflow(secondaryImei);
            } else {
              // Update sidebar: Step 5 completed, unlock Step 6
              updateStepStatus(5, 'completed');
              unlockNextStep(5);
              
              showConfirmationStep();
            }
          });
        }, 1000);
      }

      // Handle proximity check failure
      function handleProximityFailure(distance, method) {
        consecutiveLocationFailures++;
        console.log(`Proximity check failed via ${method}. Distance: ${distance.toFixed(0)}m. Failures: ${consecutiveLocationFailures}`);
        
        if (consecutiveLocationFailures >= MAX_CONSECUTIVE_FAILURES) {
          // Too many consecutive failures, show manual options
          installStatus.innerHTML = `
            <div style="color: #dc2626; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">üìç Location mismatch detected</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                Device location: ${distance.toFixed(0)}m away from your position.<br>
                This could be due to:
              </div>
              <ul style="font-size: 0.95rem; margin-bottom: 16px; padding-left: 24px; line-height: 1.6;">
                <li>Device reporting its last known location (not current)</li>
                <li>GPS accuracy issues on either device</li>
                <li>Device not yet moved to installation location</li>
              </ul>
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 16px; color: #92400e;">
              <strong>Options:</strong>
              <div style="margin-top: 12px;">
                <button id="continuePollingBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-right: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîÑ Continue Waiting</button>
              </div>
            </div>
          `;

          // Add event listeners
          document.getElementById("continuePollingBtn").addEventListener("click", () => {
            consecutiveLocationFailures = 0; // Reset counter
            scheduleNextCheck();
          });

        } else {
          // Just continue polling, but show the issue
          installStatus.innerHTML = `
            <div style="color: #d97706; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚ö†Ô∏è Location mismatch (${consecutiveLocationFailures}/${MAX_CONSECUTIVE_FAILURES})</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                Device is ${distance.toFixed(0)}m away. This might be stale location data.<br>
                Continuing to monitor for updated location...
              </div>
            </div>
            <button id="stopPollingBtn" type="button" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-top: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">üõë Stop Waiting</button>
            <button id="forceLocationCheckBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-left: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîç Check Now</button>
          `;

          // Add event listeners
          document.getElementById("stopPollingBtn").addEventListener("click", () => {
            window.stopPolling = true;
            installStatus.innerHTML = "üõë Stopped waiting for device. You can restart the installation process.";
          });

          document.getElementById("forceLocationCheckBtn").addEventListener("click", () => {
            currentInterval = 1000; // Check in 1 second
            checkStatus();
          });

          scheduleNextCheck();
        }
      }


      // Schedule the next check at steady 1-minute intervals
      function scheduleNextCheck() {
        if (window.stopPolling) return;
        
        // Keep interval steady at 1 minute
        currentInterval = STEADY_INTERVAL;
        
        console.log(`Scheduling next check in ${Math.ceil(currentInterval/1000)}s (steady interval)`);
        setTimeout(checkStatus, currentInterval);
      }

      // Start the first check
      checkStatus();
    }

    // Secondary Device Workflow (Steps 35-40) - Simplified workflow without location validation
    async function startSecondaryDeviceWorkflow(secondaryImei) {
      console.log("üöÄ Starting secondary device workflow for IMEI:", secondaryImei);
      
      // Update status to show secondary device processing
      installStatus.innerHTML = `
        <div style="margin-bottom: 20px;">
          <div style="font-size: 1.2rem; color: #6B21A8; margin-bottom: 12px; font-weight: 700;">
            üîÑ Starting Secondary Device Installation
          </div>
          <div style="font-size: 0.95rem; color: #475569; margin-bottom: 12px; line-height: 1.5;">
            <strong>Secondary IMEI:</strong> ${secondaryImei}<br>
            <strong>Status:</strong> Proceeding directly to form opening...
          </div>
          <div class="info-box" style="margin-bottom: 12px;">
            üí° <strong>Secondary Device:</strong> No location validation required - proceeding directly to installation form.
          </div>
        </div>
      `;
      
      // Skip location validation and proceed directly to form opening
      setTimeout(() => {
        openSecondaryDevicePrefilledForm();
        
        // Show secondary device form completion interface
        installStatus.innerHTML = `
          <div style="color: #059669; margin-bottom: 20px;">
            <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚úÖ Secondary Device Form Opened!</div>
            <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
              The secondary device installation form has been opened in a new tab.<br>
              Please complete the form and then click the button below to continue.
            </div>
            <div class="info-box" style="margin-bottom: 16px;">
              üí° <strong>Next Step:</strong> Complete the secondary device installation form, then click the button below.
            </div>
          </div>
          <button id="secondaryFormCompletedBtn" type="button" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">
            ‚úÖ Secondary Device Form Completed
          </button>
        `;
        
        // Add event listener for the secondary form completion button
        document.getElementById("secondaryFormCompletedBtn").addEventListener("click", function() {
          // Complete secondary device workflow and proceed to final confirmation
          completeSecondaryDeviceWorkflow(false); // false = not skipped
        });
      }, 1000);
    }
    
    // REMOVED: pollForSecondaryDeviceReporting function - no longer needed since secondary device doesn't require location validation
    /*
    function pollForSecondaryDeviceReporting(secondaryImei) {
      // Smart polling with progressive backoff and extended timeout
      const MAX_DURATION = 30 * 60 * 1000; // 30 minutes total
      const INITIAL_INTERVAL = 10000; // Start with 10 seconds
      const MAX_INTERVAL = 120000; // Max 2 minutes between checks
      const BACKOFF_MULTIPLIER = 1.5; // Increase interval by 50% each time
      
      let attempts = 0;
      let currentInterval = INITIAL_INTERVAL;
      let startTime = Date.now();
      let consecutiveLocationFailures = 0;
      const MAX_CONSECUTIVE_FAILURES = 3;
      
      // Update the status display with better information
      function updateSecondaryStatusDisplay() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const nextCheckIn = Math.ceil(currentInterval / 1000);
        
        installStatus.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-size: 1.2rem; color: #6B21A8; margin-bottom: 12px; font-weight: 700;">
              ‚è≥ Waiting for Secondary Device to Report Location...
            </div>
            <div style="font-size: 0.95rem; color: #475569; margin-bottom: 10px; line-height: 1.5;">
              <strong>Secondary IMEI:</strong> ${secondaryImei}<br>
              <strong>Elapsed time:</strong> ${timeStr} | <strong>Next check in:</strong> ${nextCheckIn}s
            </div>
            <div style="font-size: 0.95rem; color: #475569; margin-bottom: 12px; line-height: 1.5;">
              <strong>Attempts:</strong> ${attempts} | <strong>Current interval:</strong> ${Math.ceil(currentInterval/1000)}s
            </div>
            <div class="info-box" style="margin-bottom: 12px;">
              üí° <strong>Secondary Device:</strong> Device may take up to 30 minutes to report. We'll check less frequently over time.
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; color: #92400e;">
              üîç <strong>Enhanced Requirements:</strong> Secondary device must be online, have recent connection data (‚â§5min), recent network activity (‚â§5min), AND fresh location data (‚â§60s old)
            </div>
          </div>
          <button id="stopSecondaryPollingBtn" type="button" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-top: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">üõë Stop Waiting</button>
          <button id="forceSecondaryLocationCheckBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-left: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîç Check Now</button>
        `;

        // Add event listeners for the new buttons
        document.getElementById("stopSecondaryPollingBtn").addEventListener("click", () => {
          window.stopSecondaryPolling = true;
          installStatus.innerHTML = "üõë Stopped waiting for secondary device. You can restart the installation process.";
        });

        document.getElementById("forceSecondaryLocationCheckBtn").addEventListener("click", () => {
          // Force an immediate check
          currentInterval = 1000; // Check in 1 second
          checkSecondaryStatus();
        });
      }

      async function checkSecondaryStatus() {
        // Check if polling was stopped
        if (window.stopSecondaryPolling) {
          console.log("Secondary device polling stopped by user");
          return;
        }

        // Check if we've exceeded the maximum duration
        if (Date.now() - startTime > MAX_DURATION) {
          installStatus.innerHTML = `
            <div style="color: #dc2626; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚è∞ Secondary Device Time Limit Reached (30 minutes)</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                The secondary device has not reported location within the expected timeframe. This could indicate:
              </div>
              <ul style="font-size: 0.95rem; margin-bottom: 16px; padding-left: 24px; line-height: 1.6;">
                <li>Secondary device is not properly connected or powered</li>
                <li>Network connectivity issues</li>
                <li>Secondary device configuration problems</li>
              </ul>
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 16px; color: #92400e;">
              <strong>Options:</strong>
              <div style="margin-top: 12px;">
                <button id="retrySecondaryPollingBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-right: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîÑ Restart Secondary Device Polling</button>
                <button id="skipSecondaryDeviceBtn" type="button" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); margin-left: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);">‚è≠Ô∏è Skip Secondary Device</button>
              </div>
            </div>
          `;

          // Add event listeners for the options
          document.getElementById("retrySecondaryPollingBtn").addEventListener("click", () => {
            startTime = Date.now();
            attempts = 0;
            currentInterval = INITIAL_INTERVAL;
            consecutiveLocationFailures = 0;
            checkSecondaryStatus();
          });

          document.getElementById("skipSecondaryDeviceBtn").addEventListener("click", () => {
            // Skip secondary device and proceed to final confirmation
            completeSecondaryDeviceWorkflow(true); // true = skipped
          });

          return;
        }

        attempts++;
        console.log(`Checking secondary device status (attempt ${attempts}, interval: ${Math.ceil(currentInterval/1000)}s)...`);
        
        // Update status display
        updateSecondaryStatusDisplay();

        try {
          // Call backend endpoint to check secondary device status
          const resp = await fetch(`/api/device-status?imei=${encodeURIComponent(secondaryImei)}`, {
            headers: getAuthHeaders()
          });
          const data = await resp.json();
          
          // Log detailed secondary device status for debugging
          console.log("Secondary device status check:", {
            isReporting: data.isReporting,
            hasValidLocation: data.latest?.loc?.lat != null && data.latest?.loc?.lon != null && (data.latest?.loc?.age || 0) <= 60,
            isOnline: data.connection?.online,
            connectionState: data.connection?.state,
            locationAge: data.latest?.loc?.age,
            locationData: data.latest?.loc
          });
          
          // Enhanced validation using backend analysis
          const isDeviceOnline = data.isOnline === true;
          const hasValidLocation = data.latest?.loc?.lat != null && data.latest?.loc?.lon != null && (data.latest?.loc?.age || 0) <= 60;
          const locationAge = data.latest?.loc?.age || 0;
          const hasRecentConnection = data.hasRecentConnection === true;
          const hasRecentActivity = data.hasRecentActivity === true;
          
          // Comprehensive validation - ALL conditions must be true
          if (data.isReporting && hasValidLocation && isDeviceOnline && hasRecentConnection && hasRecentActivity && locationAge <= 60) {
            console.log("Secondary device is online and reporting fresh location, checking proximity...");
            
            // Get secondary device location data
            const deviceLat = data.latest.loc.lat;
            const deviceLon = data.latest.loc.lon;

            if (deviceLat == null || deviceLon == null) {
              console.log("Secondary device location data incomplete, continuing to poll...");
              scheduleNextSecondaryCheck();
              return;
            }

            // Check if this is a reasonable location (not obviously wrong)
            if (Math.abs(deviceLat) > 90 || Math.abs(deviceLon) > 180) {
              console.log("Secondary device reported invalid coordinates, continuing to poll...");
              scheduleNextSecondaryCheck();
              return;
            }

            // Check location age - if it's very old, it might be stale data
            if (locationAge > 300) { // 5 minutes old
              console.log(`Secondary device location is ${locationAge}s old, might be stale. Continuing to poll...`);
              scheduleNextSecondaryCheck();
              return;
            }

            // Now check user proximity to secondary device
            await checkSecondaryDeviceProximity(deviceLat, deviceLon);
            
          } else {
            // Enhanced logging showing exactly why each check failed
            console.log("üîç Secondary device validation failed - analyzing reasons:");
            
            if (!data.isReporting) {
              console.log("‚ùå Secondary device not reporting data yet");
            } else {
              console.log("‚úÖ Secondary device is reporting data");
            }
            
            if (!hasValidLocation) {
              console.log("‚ùå Secondary device data available but no valid location");
            } else {
              console.log("‚úÖ Secondary device has valid location");
            }
            
            if (!isDeviceOnline) {
              console.log("‚ùå Secondary device has location but is offline");
            } else {
              console.log("‚úÖ Secondary device connection is online");
            }
            
            if (!hasRecentConnection) {
              console.log("‚ùå Secondary device connection data is stale (>5 minutes old)");
            } else {
              console.log("‚úÖ Secondary device has recent connection");
            }
            
            if (!hasRecentActivity) {
              console.log("‚ùå Secondary device network activity is stale (>5 minutes old)");
            } else {
              console.log("‚úÖ Secondary device has recent network activity");
            }
            
            if (locationAge > 60) {
              console.log(`‚ùå Secondary device location is ${locationAge}s old (max 60s)`);
            } else {
              console.log("‚úÖ Secondary device location is fresh");
            }
            
            // Continue polling
            scheduleNextSecondaryCheck();
          }
          
        } catch (error) {
          console.error("Error checking secondary device status:", error);
          scheduleNextSecondaryCheck();
        }
      }

      // Function to check user proximity to secondary device
      async function checkSecondaryDeviceProximity(deviceLat, deviceLon) {
        try {
          // Check if test mode is enabled
          const testModeEnabled = document.getElementById("enableTestMode").checked;
          
          if (testModeEnabled) {
            // Use test coordinates
            const testLat = parseFloat(document.getElementById("testLatInput").value);
            const testLon = parseFloat(document.getElementById("testLonInput").value);
            
            if (isNaN(testLat) || isNaN(testLon)) {
              console.log("Test coordinates not entered, continuing to poll...");
              scheduleNextSecondaryCheck();
              return;
            }
            
            console.log(`üß™ Test Mode: Using coordinates ${testLat}, ${testLon}`);
            console.log(`üß™ Secondary device coordinates: ${deviceLat}, ${deviceLon}`);
            const distance = haversineDistance(testLat, testLon, deviceLat, deviceLon);
            console.log(`üß™ Calculated distance: ${distance.toFixed(2)}m`);
            
            if (distance < 200) {
              handleSecondaryDeviceProximitySuccess("Test Mode");
            } else {
              handleSecondaryDeviceProximityFailure(distance, "Test Mode");
            }
          } else {
            // Use GPS location
            navigator.geolocation.getCurrentPosition(
              function(position) {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const distance = haversineDistance(userLat, userLon, deviceLat, deviceLon);
                
                if (distance < 200) {
                  handleSecondaryDeviceProximitySuccess("GPS");
                } else {
                  handleSecondaryDeviceProximityFailure(distance, "GPS");
                }
              },
              function(error) {
                console.log("GPS error, showing manual location options...");
                showSecondaryDeviceManualLocationOverride(deviceLat, deviceLon);
              },
              { 
                enableHighAccuracy: true, 
                timeout: 15000, 
                maximumAge: 60000 
              }
            );
          }

        } catch (error) {
          console.error("Error in secondary device proximity check:", error);
          scheduleNextSecondaryCheck();
        }
      }

      // Handle successful secondary device proximity check
      function handleSecondaryDeviceProximitySuccess(method) {
        console.log(`Secondary device proximity check successful via ${method}`);
        
        const testModeIndicator = method === "Test Mode" ? 
          '<div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 16px; color: #92400e;">üß™ <strong>Test Mode Active:</strong> Using custom coordinates for secondary device proximity check</div>' : '';
        
        installStatus.innerHTML = `
          <div style="color: #059669; margin-bottom: 20px;">
            <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚úÖ Secondary Device Location Check Passed!</div>
            <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
              You are within 200 meters of the secondary device. Opening secondary device installation form...
            </div>
            ${testModeIndicator}
          </div>
        `;
        
        setTimeout(() => {
          console.log("Opening secondary device prefilled form...");
          openSecondaryDevicePrefilledForm();
          console.log("Secondary device form opened successfully");
          
          // Update sidebar: Secondary device workflow completed
          updateStepStatus(4, 'completed'); // This represents the secondary device completion
          
          // Show secondary device form completion interface
          installStatus.innerHTML = `
            <div style="color: #059669; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚úÖ Secondary Device Form Opened!</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                The secondary device installation form has been opened in a new tab.<br>
                Please complete the form and then click the button below to continue.
              </div>
              <div class="info-box" style="margin-bottom: 16px;">
                üí° <strong>Next Step:</strong> Complete the secondary device installation form, then click the button below.
              </div>
            </div>
            <button id="secondaryFormCompletedBtn" type="button" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);">
              ‚úÖ Secondary Device Form Completed
            </button>
          `;
          
          // Add event listener for the secondary form completion button
          document.getElementById("secondaryFormCompletedBtn").addEventListener("click", function() {
            // Complete secondary device workflow and proceed to final confirmation
            completeSecondaryDeviceWorkflow(false); // false = not skipped
          });
        }, 1000);
      }

      // Handle secondary device proximity check failure
      function handleSecondaryDeviceProximityFailure(distance, method) {
        consecutiveLocationFailures++;
        console.log(`Secondary device proximity check failed via ${method}. Distance: ${distance.toFixed(0)}m. Failures: ${consecutiveLocationFailures}`);
        
        if (consecutiveLocationFailures >= MAX_CONSECUTIVE_FAILURES) {
          // Too many consecutive failures, show manual options
          installStatus.innerHTML = `
            <div style="color: #dc2626; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">üìç Secondary Device Location Mismatch Detected</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                Secondary device location: ${distance.toFixed(0)}m away from your position.<br>
                This could be due to:
              </div>
              <ul style="font-size: 0.95rem; margin-bottom: 16px; padding-left: 24px; line-height: 1.6;">
                <li>Secondary device reporting its last known location (not current)</li>
                <li>GPS accuracy issues on either device</li>
                <li>Secondary device not yet moved to installation location</li>
              </ul>
            </div>
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 16px; color: #92400e;">
              <strong>Options:</strong>
              <div style="margin-top: 12px;">
                <button id="continueSecondaryPollingBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-right: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîÑ Continue Waiting</button>
                <button id="skipSecondaryDeviceBtn" type="button" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); margin-left: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);">‚è≠Ô∏è Skip Secondary Device</button>
              </div>
            </div>
          `;

          // Add event listeners
          document.getElementById("continueSecondaryPollingBtn").addEventListener("click", () => {
            consecutiveLocationFailures = 0; // Reset counter
            scheduleNextSecondaryCheck();
          });

          document.getElementById("skipSecondaryDeviceBtn").addEventListener("click", () => {
            // Skip secondary device and proceed to final confirmation
            completeSecondaryDeviceWorkflow(true); // true = skipped
          });

        } else {
          // Just continue polling, but show the issue
          installStatus.innerHTML = `
            <div style="color: #d97706; margin-bottom: 20px;">
              <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚ö†Ô∏è Secondary Device Location Mismatch (${consecutiveLocationFailures}/${MAX_CONSECUTIVE_FAILURES})</div>
              <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                Secondary device is ${distance.toFixed(0)}m away. This might be stale location data.<br>
                Continuing to monitor for updated location...
              </div>
            </div>
            <button id="stopSecondaryPollingBtn" type="button" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-top: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">üõë Stop Waiting</button>
            <button id="forceSecondaryLocationCheckBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); margin-left: 12px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);">üîç Check Now</button>
          `;

          // Add event listeners
          document.getElementById("stopSecondaryPollingBtn").addEventListener("click", () => {
            window.stopSecondaryPolling = true;
            installStatus.innerHTML = "üõë Stopped waiting for secondary device. You can restart the installation process.";
          });

          document.getElementById("forceSecondaryLocationCheckBtn").addEventListener("click", () => {
            currentInterval = 1000; // Check in 1 second
            checkSecondaryStatus();
          });

          scheduleNextSecondaryCheck();
        }
      }

      // Schedule the next secondary device check with progressive backoff
      function scheduleNextSecondaryCheck() {
        if (window.stopSecondaryPolling) return;
        
        // Increase interval progressively, but cap it
        currentInterval = Math.min(currentInterval * BACKOFF_MULTIPLIER, MAX_INTERVAL);
        
        console.log(`Scheduling next secondary device check in ${Math.ceil(currentInterval/1000)}s`);
        setTimeout(checkSecondaryStatus, currentInterval);
      }

      // Start the first secondary device check
      checkSecondaryStatus();
    }
    */

    // Complete secondary device workflow and proceed to final confirmation
    function completeSecondaryDeviceWorkflow(skipped) {
      if (skipped) {
        console.log("Secondary device installation skipped");
        installStatus.innerHTML = `
          <div style="color: #d97706; margin-bottom: 20px;">
            <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚è≠Ô∏è Secondary Device Installation Skipped</div>
            <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
              The secondary device installation has been skipped.<br>
              Proceeding to final confirmation for primary device only.
            </div>
          </div>
        `;
      } else {
        console.log("Secondary device installation completed");
        installStatus.innerHTML = `
          <div style="color: #059669; margin-bottom: 20px;">
            <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">‚úÖ Secondary Device Installation Completed</div>
            <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
              The secondary device installation has been completed successfully.<br>
              Both primary and secondary devices are now installed.
            </div>
          </div>
        `;
      }
      
      // Wait a moment then proceed to final confirmation
      setTimeout(() => {
        // Update sidebar: Step 5 completed, unlock Step 6
        updateStepStatus(5, 'completed');
        unlockNextStep(5);
        
        showConfirmationStep();
      }, 2000);
    }

    // Open secondary device prefilled form
    function openSecondaryDevicePrefilledForm() {
      const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
      if (!inst || !inst.vehiculo) {
        alert("No installation data found for secondary device!");
        return;
      }
      
      // Get the primary VIN and create secondary VIN name with "(2)" suffix
      const primaryVin = inst.vehiculo?.vin || inst.vehiculo?.serie || "";
      const secondaryVinName = primaryVin ? `${primaryVin}(2)` : "Secondary Device";
      
      // Map your JSON fields to the form's query params for secondary device
      const params = new URLSearchParams({
        installationId: inst._id,
        driverName: inst.persona?.nombreAsegurado || "",
        "driverName[last]": inst.persona?.apellidoPaterno || "",
        email: inst.persona?.contactos?.[0]?.email || "",
        serviceType: inst.persona?.tipo || "",
        vin: secondaryVinName, // Use VIN(2) naming convention
        imei: document.getElementById("secondaryImeiInput").value.trim(), // Use secondary IMEI
        deviceType: "secondary", // Mark as secondary device
        primaryImei: imeiInput.value.trim() // Include primary IMEI for reference
      });
      
      // Update workflow status for secondary device
      updateWorkflowStatus({
        currentStep: 'Secondary Device Form',
        secondaryImei: document.getElementById("secondaryImeiInput").value.trim(),
        status: `Secondary device form opened for ${secondaryVinName}`
      });
      
      // Open the form in a new tab
      const formUrl = `https://forms.office.com/Pages/ResponsePage.aspx?id=DQSIkWdsW0yxEjajBLZtrQAAAAAAAAAAAAO__c8nLFtUMjE2NldORzYyTy4u&${params.toString()}`;
      window.open(formUrl, '_blank');
    }

    // Show manual location override for secondary device
    function showSecondaryDeviceManualLocationOverride(deviceLat, deviceLon) {
      installStatus.innerHTML = `
        <div style="color: #d97706; margin-bottom: 20px;">
          <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 700;">üìç Manual Location Entry Required</div>
          <div style="font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
            GPS location could not be determined automatically.<br>
            <strong>Secondary Device Location:</strong> ${deviceLat}, ${deviceLon}<br>
            Please enter your current coordinates manually.
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label for="manualLatInput" style="font-size: 0.9rem; color: #92400e; font-weight: 600;">Your Latitude:</label>
            <input type="number" id="manualLatInput" placeholder="e.g., 25.78395" step="0.00001" style="font-size: 0.9rem; padding: 10px 12px; border: 2px solid #f59e0b; border-radius: 8px; background: #fff;" />
          </div>
          <div>
            <label for="manualLonInput" style="font-size: 0.9rem; color: #92400e; font-weight: 600;">Your Longitude:</label>
            <input type="number" id="manualLonInput" placeholder="e.g., -100.26345" step="0.00001" style="font-size: 0.9rem; padding: 10px 12px; border: 2px solid #f59e0b; border-radius: 8px; background: #fff;" />
          </div>
        </div>
        <button id="checkManualProximityBtn" type="button" style="background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); color: white; border: none; border-radius: 6px; padding: 8px 16px; font-size: 0.9rem; cursor: pointer; font-weight: 600; box-shadow: 0 2px 6px rgba(134, 43, 171, 0.3);">
          üîç Check Proximity
        </button>
      `;
      
      // Add event listener for manual proximity check
      document.getElementById("checkManualProximityBtn").addEventListener("click", function() {
        const manualLat = parseFloat(document.getElementById("manualLatInput").value);
        const manualLon = parseFloat(document.getElementById("manualLonInput").value);
        
        if (isNaN(manualLat) || isNaN(manualLon)) {
          alert("Please enter valid coordinates");
          return;
        }
        
        const distance = haversineDistance(manualLat, manualLon, deviceLat, deviceLon);
        console.log(`Manual coordinates: ${manualLat}, ${manualLon}`);
        console.log(`Secondary device coordinates: ${deviceLat}, ${deviceLon}`);
        console.log(`Calculated distance: ${distance.toFixed(2)}m`);
        
        if (distance < 200) {
          handleSecondaryDeviceProximitySuccess("Manual Entry");
        } else {
          handleSecondaryDeviceProximityFailure(distance, "Manual Entry");
        }
      });
    }

    function openPrefilledForm() {
      const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
      if (!inst || !inst.vehiculo) {
        alert("No installation data found!");
        return;
      }
      // Map your JSON fields to the form's query params
      const params = new URLSearchParams({
        installationId: inst._id,
        driverName: inst.persona?.nombreAsegurado || "",
        "driverName[last]": inst.persona?.apellidoPaterno || "",
        email: inst.persona?.contactos?.[0]?.email || "",
        serviceType: inst.persona?.tipo || "",
        enterpriseName: inst.persona?.nombreAsegurado + " " + inst.persona?.apellidoPaterno,
        typeA127: "Instalaci√≥n",
        plate: inst.vehiculo?.placas || "",
        make: inst.vehiculo?.marca || "",
        model: inst.vehiculo?.submarca || "",
        ano: inst.vehiculo?.modelo || "",
        vin: inst.vehiculo?.serie || "",
        color: inst.vehiculo?.color || "",
        numeroEconomico: inst.vehiculo?.numeroEconomico || "",
        noDe: inst.vehiculo?.numeroMotor || ""
      });
      // Use environment-specific form URLs
      const formId = appConfig.environment === "qa" ? "252054474420955" : "232983887026974";
      const url = `https://forms.fleetmetriks.com/${formId}?${params.toString()}`;
      console.log(`üîó Opening ${appConfig.environment.toUpperCase()} form: ${url}`);
      
      // Update workflow status
      updateWorkflowStatus({
        currentStep: '5',
        status: 'Form opened - Complete installation details'
      });
      
      window.open(url, "_blank"); // or use location.href = url; to redirect in the same tab
    }

    // BACK handlers
    function onBackToClient() {
      vinSection.classList.add("hidden");
      clientSection.classList.remove("hidden");
    }
    function onBackToVin() {
      deviceSection.classList.add("hidden");
      vinSection.classList.remove("hidden");
    }



    // SHOW CONFIRMATION STEP
    function showConfirmationStep() {
      deviceSection.classList.add("hidden");
      confirmationSection.classList.remove("hidden");
      sessionStorage.setItem("step", "confirmation");
    }

    // FINAL CONFIRMATION HANDLER
    async function onFinalConfirmation() {
      confirmationStatus.innerText = "üîÑ Sending final confirmation to system...";
      finalConfirmBtn.disabled = true;
      
      try {
        const resp = await fetch("/api/confirm-installation", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ 
            installationId: selectedInstallationId 
          })
        });

        const data = await resp.json();

        if (resp.ok && data.success) {
          // Update sidebar: Step 6 completed
          updateStepStatus(6, 'completed');
          
          // Update workflow status
          updateWorkflowStatus({
            currentStep: '6',
            status: 'Installation confirmed successfully! üéâ'
          });
          
          confirmationStatus.innerText = "‚úÖ Installation confirmed successfully!";
          setTimeout(() => {
            confirmationSection.classList.add("hidden");
            successMsg.style.display = "block";
            sessionStorage.setItem("step", "done");
          }, 1500);
        } else {
          confirmationStatus.innerText = `‚ùå Confirmation failed: ${data.message}`;
          finalConfirmBtn.disabled = false;
          console.error("Confirmation failed:", data);
        }
      } catch (err) {
        console.error("Error confirming installation:", err);
        confirmationStatus.innerText = "‚ùå Error confirming installation. Please try again.";
        finalConfirmBtn.disabled = false;
      }
    }

    // Restore UI on reload
    function restoreState() {
      const step = sessionStorage.getItem("step") || "1";
      const currentStep = parseInt(step);
      
      // Reset verification states
      imeiVerified = false;
      simVerified = false;
      startInstallBtn.disabled = true;
      imeiVerificationStatus.innerHTML = "";
      simVerificationStatus.innerHTML = "";
      
      // Add location permission request button if geolocation is supported
      if (navigator.geolocation) {
        const locationPermissionBtn = document.createElement("button");
        locationPermissionBtn.type = "button";
        locationPermissionBtn.textContent = "üìç Request Location Permission";
        locationPermissionBtn.style.cssText = "background: linear-gradient(135deg, #862BAB 0%, #6B21A8 100%); color: white; font-size: 0.9rem; padding: 10px 18px; margin-top: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(134, 43, 171, 0.3);";
        locationPermissionBtn.addEventListener("click", requestLocationPermission);
        
        const locationOptionsDiv = document.querySelector(".content-container").querySelector('[style*="background: #e8f4fd"]');
        if (locationOptionsDiv) {
          locationOptionsDiv.appendChild(locationPermissionBtn);
        }
      }

      // Restore step data and update sidebar
      if (step === "2") {
        // restore Step 2 data
        clientNameInput.value = sessionStorage.getItem("clientName") || "";
        const filtered = JSON.parse(sessionStorage.getItem("filteredInst") || "[]");
        vinSelect.innerHTML = `<option value="">-- Select VIN --</option>`;
        filtered.forEach(inst => {
          const vin = inst.vehiculo?.serie;
          if (!vin) return;
          const opt = document.createElement("option");
          opt.value = vin;
          opt.textContent = vin;
          opt.dataset.installationId = inst._id;
          if (vin === sessionStorage.getItem("selectedVIN")) opt.selected = true;
          vinSelect.appendChild(opt);
        });
        
        // Restore workflow status
        updateWorkflowStatus({
          currentStep: '2',
          status: `Found ${filtered.length} installation(s) for "${sessionStorage.getItem("clientName")}"`
        });
        
        // Update sidebar status
        updateStepStatus(1, 'completed');
        unlockNextStep(1);
        navigateToStep(2);

      } else if (step === "3") {
        // restore Step 3 data
        onNextVin();
        
        // Restore workflow status for step 3
        const selectedVIN = sessionStorage.getItem("selectedVIN");
        if (selectedVIN) {
          updateWorkflowStatus({
            currentStep: '3',
            vin: selectedVIN,
            status: `Selected VIN: ${selectedVIN}`
          });
        }
        
      } else if (step === "confirmation") {
        // restore confirmation step
        updateStepStatus(5, 'completed');
        unlockNextStep(5);
        navigateToStep(6);
        
      } else if (step === "done") {
        // show success message and mark all steps as completed
        successMsg.style.display = "block";
        updateStepStatus(1, 'completed');
        updateStepStatus(2, 'completed');
        updateStepStatus(3, 'completed');
        updateStepStatus(4, 'completed');
        updateStepStatus(5, 'completed');
        updateStepStatus(6, 'completed');
        
      } else {
        // default to Step 1
        navigateToStep(1);
      }
    }

    function debugPrint(obj, label = "") {
      const out = document.getElementById("debugOutput");
      out.textContent = (label ? label + ":\n" : "") + JSON.stringify(obj, null, 2);
    }

    // Update device location display for test mode
    function updateDeviceLocationDisplay() {
      const inst = JSON.parse(sessionStorage.getItem("selectedInstallation") || "{}");
      const deviceLat = inst.vehiculo?.latest?.loc?.lat;
      const deviceLon = inst.vehiculo?.latest?.loc?.lon;
      
      const displayElement = document.getElementById("deviceLocationDisplay");
      if (deviceLat && deviceLon) {
        displayElement.innerHTML = `${deviceLat.toFixed(5)}, ${deviceLon.toFixed(5)}`;
        
        // Auto-populate test coordinates with device location for easy testing
        document.getElementById("testLatInput").value = deviceLat.toFixed(5);
        document.getElementById("testLonInput").value = deviceLon.toFixed(5);
      } else {
        displayElement.innerHTML = "Device location not available yet";
      }
    }
    
    // Request location permission proactively
    function requestLocationPermission() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          alert("‚úÖ Location permission granted! Your coordinates: " + 
                position.coords.latitude.toFixed(6) + ", " + 
                position.coords.longitude.toFixed(6));
        },
        function(error) {
          let errorMsg = "";
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = "Location permission denied. Please:\n1. Click the location icon in your browser's address bar\n2. Select 'Allow' for location access\n3. Refresh the page";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = "Location information unavailable. Please check your device's location services.";
              break;
            case error.TIMEOUT:
              errorMsg = "Location request timed out. Please try again.";
              break;
            default:
              errorMsg = "Location error: " + error.message;
          }
          alert("‚ùå " + errorMsg);
        },
        { 
          enableHighAccuracy: true, 
          timeout: 10000, 
          maximumAge: 60000 
        }
      );
    }

    // Haversine Distance calculation (for proximity check)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of Earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c; // Distance in km
      return distance;
    }
    
    // Workflow Status Bar Functions
    function showWorkflowStatusBar() {
      const statusBar = document.getElementById('workflowStatusBar');
      if (statusBar) {
        statusBar.style.display = 'block';
      }
    }
    
    function updateWorkflowStatus(updates) {
      // Check if status bar exists before proceeding
      const statusBar = document.getElementById('workflowStatusBar');
      if (!statusBar) {
        return; // Exit early if status bar doesn't exist
      }
      
      // Show the status bar if it's hidden
      showWorkflowStatusBar();
      
      // Update each field if provided, with null checks
      if (updates.currentStep) {
        const stepElement = document.getElementById('currentStepDisplay');
        if (stepElement) stepElement.textContent = updates.currentStep;
      }
      if (updates.vin) {
        const vinElement = document.getElementById('currentVinDisplay');
        if (vinElement) vinElement.textContent = updates.vin;
      }
      if (updates.primaryImei) {
        const primaryElement = document.getElementById('currentPrimaryImeiDisplay');
        if (primaryElement) primaryElement.textContent = updates.primaryImei;
      }
      if (updates.secondaryImei) {
        const secondaryElement = document.getElementById('currentSecondaryImeiDisplay');
        if (secondaryElement) secondaryElement.textContent = updates.secondaryImei;
      }
      if (updates.status) {
        const statusElement = document.getElementById('currentStatusDisplay');
        if (statusElement) statusElement.textContent = updates.status;
      }
    }
    
    function clearWorkflowStatus() {
      // Check if status bar exists before proceeding
      const statusBar = document.getElementById('workflowStatusBar');
      if (!statusBar) {
        return; // Exit early if status bar doesn't exist
      }
      
      const stepElement = document.getElementById('currentStepDisplay');
      const vinElement = document.getElementById('currentVinDisplay');
      const primaryElement = document.getElementById('currentPrimaryImeiDisplay');
      const secondaryElement = document.getElementById('currentSecondaryImeiDisplay');
      const statusElement = document.getElementById('currentStatusDisplay');
      
      if (stepElement) stepElement.textContent = '1';
      if (vinElement) vinElement.textContent = '-';
      if (primaryElement) primaryElement.textContent = '-';
      if (secondaryElement) secondaryElement.textContent = '-';
      if (statusElement) statusElement.textContent = 'Ready to start';
    }
    
    // User authentication functions
    function setupUserInfo() {
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      const userInfoElement = document.getElementById('userInfo');
      const userNameElement = document.getElementById('userName');
      const userRoleElement = document.getElementById('userRole');
      const logoutBtn = document.getElementById('logoutBtn');
      
      if (userInfo.name && userInfo.role) {
        userNameElement.textContent = userInfo.name;
        userRoleElement.textContent = userInfo.role;
        userInfoElement.style.display = 'block';
      }
      
      // Setup logout functionality
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
        } finally {
          // Clear local storage and redirect to login
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });
    }
    
    // Add authentication headers to all API calls
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

  </script>
</body>
</html>